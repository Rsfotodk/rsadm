<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RSADM ‚Äì Job & Faktura Overblik</title>

  <style>
    :root{
      --maxw: 1200px;
      --pad: 24px;
      --border: #e8e8e8;
      --muted: #555;
      --muted2:#666;
      --bg: #fff;
      --btn: #111;
      --btnText:#fff;
      --btn2:#eee;
      --btn2Text:#111;
      --danger:#b00020;
      --shadow: 0 6px 18px rgba(0,0,0,.06);
      --pill:#f2f2f2;
      --pillPlan:#fff3cd;
      --pillDone:#d1ecf1;
      --pillInv:#d4edda;
      --pillPaid:#d4edda;
      --pillCan:#f8d7da;
    }

    *{ box-sizing: border-box; }

    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin: 0;
      background: var(--bg);
      color:#111;
    }

    .wrap{
      max-width: var(--maxw);
      margin: 24px auto;
      padding: 0 var(--pad);
    }

    h1{ margin: 0 0 6px; }
    h2{ margin: 0; }
    h3{ margin: 0; }

    .muted{ color: var(--muted); margin: 6px 0 0; }
    .small{ font-size: 12px; color: var(--muted2); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .card{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin-top: 16px;
      background: #fff;
      box-shadow: var(--shadow);
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
    }

    .topbar .right{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    label{
      display:block;
      font-size: 12px;
      color:#333;
      margin: 0 0 6px;
    }

    input, select, textarea{
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 12px;
      font-size: 14px;
      background:#fff;
    }

    textarea{ min-height: 38px; resize: vertical; }

    button{
      width:auto;
      padding: 10px 14px;
      border: none;
      border-radius: 12px;
      background: var(--btn);
      color: var(--btnText);
      cursor: pointer;
      font-size: 14px;
    }

    button.secondary{
      background: var(--btn2);
      color: var(--btn2Text);
      border: 1px solid #ccc;
    }

    button.danger{ background: var(--danger); }

    button:disabled{
      opacity: .55;
      cursor: not-allowed;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items: stretch;
      flex-wrap: wrap;
    }

    .row > *{ flex: 1; min-width: 200px; }

    table{
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td{
      border-bottom: 1px solid #eee;
      padding: 10px 6px;
      font-size: 13px;
      text-align: left;
      vertical-align: top;
    }

    th{
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .04em;
    }

    .pill{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--pill);
      font-size: 12px;
      border: 1px solid #e6e6e6;
    }
    .pill.plan{ background: var(--pillPlan); }
    .pill.done{ background: var(--pillDone); }
    .pill.inv{ background: var(--pillInv); }
    .pill.paid{ background: var(--pillPaid); }
    .pill.can{ background: var(--pillCan); }

    .totals{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .stat{
      border: 1px solid #eee;
      border-radius: 14px;
      padding: 12px;
      background:#fff;
    }

    .stat .k{ font-size: 12px; color: var(--muted2); }
    .stat .v{ font-size: 20px; font-weight: 700; }

    .hidden{ display:none !important; }

    .linkbtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 14px;
      border-radius: 12px;
      background: var(--btn2);
      color: var(--btn2Text);
      border: 1px solid #ccc;
      text-decoration: none;
      font-size: 14px;
      line-height: 1;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .totals{ grid-template-columns: 1fr; }
      .topbar{ flex-direction: column; align-items: flex-start; }
      .topbar .right{ justify-content: flex-start; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div>
        <h1>RSADM ‚Äì Job & Faktura Overblik</h1>
        <p class="muted">Login ‚Üí planl√¶g jobs ‚Üí udf√∏r ‚Üí faktur√©r ‚Üí betalt.</p>
      </div>

      <div class="right">
        <a class="linkbtn hidden" href="stats.html" id="statsLink">üìä Statistik</a>
        <div id="whoami" class="small"></div>
        <button id="logoutBtn" type="button" class="secondary hidden">Log ud</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h2>Login</h2>

      <div class="grid" style="margin-top:12px;">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="din@email.dk" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="loginBtn" type="button">Log ind</button>
        <button id="signupBtn" type="button" class="secondary">Opret bruger</button>
      </div>

      <p id="loginMsg" class="muted"></p>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">

      <!-- Categories -->
      <div class="card">
        <h2>Kategorier</h2>

        <div class="row" style="margin-top:12px;">
          <div>
            <label>Ny kategori</label>
            <input id="newCategory" placeholder="fx Fodbold / H√•ndbold / Klub / Motorsport" />
          </div>
          <div style="display:flex; align-items:flex-end;">
            <button id="addCategoryBtn" type="button">Tilf√∏j kategori</button>
          </div>
        </div>

        <p class="muted" id="catMsg"></p>
      </div>

      <!-- Planned jobs (quick list) -->
      <div class="card">
        <h2>Kommende planlagte jobs</h2>
        <p class="small muted" style="margin-top:6px;">Tip: Opret ‚ÄúPlanlagt‚Äù nu ‚Äì udfyld tid/transport/bel√∏b senere.</p>

        <table>
          <thead>
            <tr>
              <th>Dato</th>
              <th>Kunde</th>
              <th>Kategori</th>
              <th>Status</th>
              <th>Handling</th>
            </tr>
          </thead>
          <tbody id="plannedTbody"></tbody>
        </table>

        <p class="muted" id="plannedMsg"></p>
      </div>

      <!-- New job -->
      <div class="card">
        <h2>Nyt job</h2>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label>Faktura nummer (dit eget)</label>
            <input id="invoiceNo" placeholder="fx 2025-001 / e-conomic nr." />
          </div>
          <div>
            <label>Dato</label>
            <input id="jobDate" type="date" />
          </div>

          <div>
            <label>Status</label>
            <select id="statusSelect">
              <option value="planned">Planlagt</option>
              <option value="completed">Udf√∏rt</option>
              <option value="invoiced">Faktureret</option>
              <option value="paid">Betalt</option>
              <option value="canceled">Annulleret</option>
            </select>
            <div class="small muted" id="statusHint" style="margin-top:6px;"></div>
          </div>

          <div>
            <label>Kategori</label>
            <select id="categorySelect"></select>
          </div>

          <div>
            <label>Kunde</label>
            <input id="client" placeholder="fx Seven Racing / AC Horsens / Natklub" />
          </div>

          <div>
            <label>Tid brugt (skriv i minutter / 1:30 / 2t 15m)</label>
            <input id="workText" placeholder="fx 2:15" />
          </div>

          <div>
            <label>Transport total (minutter)</label>
            <input id="travelMinutes" type="number" min="0" step="1" placeholder="fx 90" />
          </div>

          <div>
            <label>Faktur√©r (bel√∏b ex. moms)</label>
            <input id="invoiceExVat" type="number" min="0" step="0.01" placeholder="fx 2000.00" />
            <div class="small muted" id="invoiceInclPreview" style="margin-top:6px;"></div>
          </div>

          <div>
            <label>Noter</label>
            <input id="notes" placeholder="fx levering / s√¶rlige aftaler" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="createJobBtn" type="button">Gem job</button>
          <button id="resetJobBtn" type="button" class="secondary">Nulstil felter</button>
        </div>

        <p id="jobMsg" class="muted"></p>
      </div>

      <!-- Stats (quick) -->
      <div class="card">
        <h2>Overblik</h2>
        <div class="totals" id="totals"></div>

        <div class="grid" style="margin-top:12px;">
          <div>
            <h3 style="margin:0 0 8px;">Jobs pr. status</h3>
            <table>
              <thead><tr><th>Status</th><th>Antal</th></tr></thead>
              <tbody id="byStatus"></tbody>
            </table>
          </div>

          <div>
            <h3 style="margin:0 0 8px;">Timer pr. m√•ned</h3>
            <table>
              <thead><tr><th>M√•ned</th><th>Timer</th></tr></thead>
              <tbody id="byMonth"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Report (own card) -->
      <div class="card" id="reportCard">
        <h2>M√•nedsrapport pr. kunde</h2>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label>M√•ned</label>
            <select id="reportMonth"></select>
          </div>
          <div>
            <label>Kunde</label>
            <select id="reportClient"></select>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="reportRefreshBtn" type="button" class="secondary">Opdater rapport</button>
          <button id="reportExportBtn" type="button">Eksport rapport CSV</button>
        </div>

        <table style="margin-top:12px;">
          <thead>
            <tr>
              <th>M√•ned</th>
              <th>Kunde</th>
              <th>Jobs</th>
              <th>Arbejdstid</th>
              <th>Transport</th>
              <th>Fakturering ex. moms</th>
            </tr>
          </thead>
          <tbody id="reportTbody"></tbody>
        </table>

        <p class="muted" id="reportMsg"></p>
      </div>

      <!-- Jobs table -->
      <div class="card">
        <div class="row" style="align-items:flex-end;">
          <div>
            <label>S√∏g (kunde, kategori, id, faktura nr.)</label>
            <input id="search" placeholder="fx seven / 2500 / klub" />
          </div>

          <div>
            <label>√Ör (filter)</label>
            <select id="yearFilter"><option value="">Alle</option></select>
          </div>

          <div>
            <label>Status (filter)</label>
            <select id="statusFilter">
              <option value="">Alle</option>
              <option value="planned">Planlagt</option>
              <option value="completed">Udf√∏rt</option>
              <option value="invoiced">Faktureret</option>
              <option value="paid">Betalt</option>
              <option value="canceled">Annulleret</option>
            </select>
          </div>

          <div style="display:flex; gap:10px; align-items:flex-end; flex:0 0 auto;">
            <button id="refreshBtn" type="button" class="secondary">Opdater</button>
            <button id="exportBtn" type="button">Eksport CSV</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Status</th>
              <th>Dato</th>
              <th>Kunde</th>
              <th>Kategori</th>
              <th>Faktura nr</th>
              <th>Tid</th>
              <th>Transport</th>
              <th>Bel√∏b ex. moms</th>
              <th>Handling</th>
            </tr>
          </thead>
          <tbody id="jobsTbody"></tbody>
        </table>

        <p class="muted" id="tableMsg"></p>
      </div>

      <!-- Edit -->
      <div id="editCard" class="card hidden">
        <h2>Ret job <span id="editId" class="mono"></span></h2>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label>Status</label>
            <select id="editStatusSelect">
              <option value="planned">Planlagt</option>
              <option value="completed">Udf√∏rt</option>
              <option value="invoiced">Faktureret</option>
              <option value="paid">Betalt</option>
              <option value="canceled">Annulleret</option>
            </select>
            <div class="small muted" id="editStatusHint" style="margin-top:6px;"></div>
          </div>

          <div>
            <label>Faktura nummer</label>
            <input id="editInvoiceNo" />
          </div>

          <div>
            <label>Dato</label>
            <input id="editJobDate" type="date" />
          </div>

          <div>
            <label>Kategori</label>
            <select id="editCategorySelect"></select>
          </div>

          <div>
            <label>Kunde</label>
            <input id="editClient" />
          </div>

          <div>
            <label>Tid brugt (tekst)</label>
            <input id="editWorkText" />
          </div>

          <div>
            <label>Transport total (min)</label>
            <input id="editTravelMinutes" type="number" min="0" step="1" />
          </div>

          <div>
            <label>Bel√∏b ex. moms</label>
            <input id="editInvoiceExVat" type="number" min="0" step="0.01" />
            <div class="small muted" id="editInvoiceInclPreview" style="margin-top:6px;"></div>
          </div>

          <div>
            <label>Noter</label>
            <input id="editNotes" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="saveEditBtn" type="button">Gem rettelse</button>
          <button id="cancelEditBtn" type="button" class="secondary">Annuller</button>
          <button id="deleteJobBtn" type="button" class="danger">Slet job</button>
        </div>

        <p id="editMsg" class="muted"></p>
      </div>

    </div><!-- /#app -->

  </div><!-- /.wrap -->

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://epzbdezmbyyduqjthdzt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwemJkZXptYnl5ZHVxanRoZHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MDU3MzAsImV4cCI6MjA4MjA4MTczMH0.d_-8frGdHnvBO6smGThEUI81KUWI39rp5VX65O_HauU";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);

    const VAT_RATE = 0.25;
    const inclVat = (exVat) => Math.round((Number(exVat)||0) * (1 + VAT_RATE) * 100) / 100;

    const fmtH = (mins) => {
      const m = Math.max(0, Math.round(Number(mins)||0));
      const h = Math.floor(m/60);
      const r = m%60;
      return `${h}:${String(r).padStart(2,'0')}`;
    };

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // Parse work text -> minutes
    function parseWorkMinutes(input){
      const s = String(input ?? "").trim().toLowerCase();
      if (!s) return 0;

      const colon = s.match(/^(\d+)\s*:\s*(\d{1,2})$/);
      if (colon) return Number(colon[1])*60 + Number(colon[2]);

      const onlyNum = s.match(/^\d+$/);
      if (onlyNum) return Number(s);

      let total = 0;
      const h = s.match(/(\d+)\s*(t|h|timer|time)/);
      const m = s.match(/(\d+)\s*(m|min|minutter|minute)/);
      if (h) total += Number(h[1]) * 60;
      if (m) total += Number(m[1]);
      return total;
    }

    function statusLabel(s){
      return ({
        planned:"Planlagt",
        completed:"Udf√∏rt",
        invoiced:"Faktureret",
        paid:"Betalt",
        canceled:"Annulleret"
      }[s] || s || "‚Äî");
    }

    function statusPillClass(s){
      return ({
        planned:"plan",
        completed:"done",
        invoiced:"inv",
        paid:"paid",
        canceled:"can"
      }[s] || "");
    }

    function shouldDisableMoneyFields(status){
      return status === "planned" || status === "canceled";
    }

    function autoStatusFromFields({ chosenStatus, work_minutes, invoice_no, invoice_amount_ex_vat, forcePaid }){
      if (chosenStatus === "canceled") return "canceled";
      if (chosenStatus === "paid" || forcePaid) return "paid";

      const hasWork = Number(work_minutes || 0) > 0;
      const hasInvoice = !!String(invoice_no || "").trim() || (invoice_amount_ex_vat !== null && invoice_amount_ex_vat !== undefined);

      // Hvis bruger v√¶lger "planned" manuelt, respekter - men kun hvis der ikke er data der modsiger
      if (chosenStatus === "planned" && !hasWork && !hasInvoice) return "planned";

      if (hasInvoice) return "invoiced";
      if (hasWork) return "completed";
      return "planned";
    }

    function stampsForStatus(nextStatus){
      const now = new Date().toISOString();
      return {
        completed_at: (nextStatus === "completed" || nextStatus === "invoiced" || nextStatus === "paid") ? now : null,
        invoiced_at: (nextStatus === "invoiced" || nextStatus === "paid") ? now : null,
        paid_at: (nextStatus === "paid") ? now : null,
        canceled_at: (nextStatus === "canceled") ? now : null,
      };
    }

    // State
    let user = null;
    let categories = [];
    let jobs = [];
    let editingId = null;

    // REPORT STATE
    let reportRows = [];

    function setLoggedInUI(isIn){
      $("loginCard").classList.toggle("hidden", isIn);
      $("app").classList.toggle("hidden", !isIn);
      $("logoutBtn").classList.toggle("hidden", !isIn);
      $("statsLink").classList.toggle("hidden", !isIn);

      $("whoami").textContent = isIn ? `Logget ind: ${user?.email ?? ""}` : "";
    }

    function updateNewInvoicePreview(){
      const ex = $("invoiceExVat").value === "" ? null : Number($("invoiceExVat").value);
      $("invoiceInclPreview").textContent = ex === null ? "" : `= ${inclVat(ex).toFixed(2)} inkl. moms`;
    }

    function updateEditInvoicePreview(){
      const ex = $("editInvoiceExVat").value === "" ? null : Number($("editInvoiceExVat").value);
      $("editInvoiceInclPreview").textContent = ex === null ? "" : `= ${inclVat(ex).toFixed(2)} inkl. moms`;
    }

    function applyNewStatusUI(){
      const s = $("statusSelect").value;
      $("statusHint").textContent =
        s === "planned" ? "Planlagt: du kan udfylde tid/transport/bel√∏b senere." :
        s === "canceled" ? "Annulleret: gemmes men t√¶ller ikke med i statistik." :
        "Tip: udfyld tid og bel√∏b ‚Äì status opdateres automatisk til Udf√∏rt/Faktureret.";

      const dis = shouldDisableMoneyFields(s);
      $("workText").disabled = dis && s === "planned";
      $("travelMinutes").disabled = dis && s === "planned";
      $("invoiceExVat").disabled = dis;
      $("invoiceNo").disabled = (s === "planned");

      if (dis && s === "planned"){
        // lad det v√¶re muligt at gemme planlagt uden alt muligt
        // men vi rydder ikke felterne automatisk
      }
      updateNewInvoicePreview();
    }

    function applyEditStatusUI(){
      const s = $("editStatusSelect").value;
      $("editStatusHint").textContent =
        s === "planned" ? "Planlagt: udfyld tid/bel√∏b senere, s√• bliver den automatisk Udf√∏rt/Faktureret." :
        s === "paid" ? "Betalt: s√¶tter paid_at (nu)." :
        s === "canceled" ? "Annulleret: t√¶ller ikke med i statistik." :
        "";
      updateEditInvoicePreview();
    }

    async function ensureDefaultCategories(){
      if (categories.length) return;
      const starter = ["Fodbold","H√•ndbold","Klub","Motorsport","Event","Bryllup","Studio"];
      const inserts = starter.map(name => ({ user_id: user.id, name }));
      const { error } = await supabase.from("categories").insert(inserts);
      if (error) console.warn(error);
      await loadCategories();
    }

    async function loadCategories(){
      const { data, error } = await supabase
        .from("categories")
        .select("id,name")
        .order("name", { ascending: true });

      if (error) {
        $("catMsg").textContent = `Fejl ved hentning af kategorier: ${error.message}`;
        categories = [];
        renderCategorySelects();
        return;
      }

      categories = data ?? [];
      renderCategorySelects();
    }

    function renderCategorySelects(){
      const opts = categories.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");
      $("categorySelect").innerHTML = `<option value="">(V√¶lg)</option>` + opts;
      $("editCategorySelect").innerHTML = `<option value="">(V√¶lg)</option>` + opts;
    }

    async function loadJobs(){
      const { data, error } = await supabase
        .from("jobs")
        .select(`
          id, status, job_date, client, invoice_no, work_minutes, work_text, travel_minutes, invoice_amount_ex_vat, notes,
          category_id,
          completed_at, invoiced_at, paid_at, canceled_at,
          categories(name)
        `)
        .order("job_date", { ascending: false })
        .order("created_at", { ascending: false });

      if (error) {
        $("tableMsg").textContent = `Fejl ved hentning af jobs: ${error.message}`;
        jobs = [];
        renderAll();
        renderPlannedList();
        return;
      }

      jobs = (data ?? []).map(r => ({
        ...r,
        category_name: r.categories?.name ?? ""
      }));

      $("tableMsg").textContent = "";
      renderAll();
      renderPlannedList();
    }

    function renderYearFilter(){
      const years = Array.from(new Set(jobs.map(j => String(j.job_date || "").slice(0,4)).filter(Boolean))).sort((a,b)=>b.localeCompare(a));
      const cur = $("yearFilter").value;
      $("yearFilter").innerHTML = `<option value="">Alle</option>` + years.map(y=>`<option value="${y}">${y}</option>`).join("");
      if (years.includes(cur)) $("yearFilter").value = cur;
    }

    function computeStats(filtered){
      // kun "rigtige" jobs t√¶ller i totals
      const counted = filtered.filter(j => ["completed","invoiced","paid"].includes(j.status));
      const totalJobs = counted.length;
      const totalWorkMin = counted.reduce((a,j)=>a+(Number(j.work_minutes)||0),0);
      const totalTravelMin = counted.reduce((a,j)=>a+(Number(j.travel_minutes)||0),0);
      const totalInvoiceEx = counted.reduce((a,j)=>a+(Number(j.invoice_amount_ex_vat)||0),0);

      const monthMap = new Map();
      for (const j of counted) {
        const y = String(j.job_date||"").slice(0,4);
        const m = String(j.job_date||"").slice(5,7);
        if (!y || !m) continue;
        const key = `${y}-${m}`;
        monthMap.set(key, (monthMap.get(key)||0) + (Number(j.work_minutes)||0));
      }

      const statusMap = new Map();
      for (const j of filtered) {
        const s = j.status || "planned";
        statusMap.set(s, (statusMap.get(s)||0) + 1);
      }

      return { totalJobs, totalWorkMin, totalTravelMin, totalInvoiceEx, monthMap, statusMap };
    }

    function renderStats(filtered){
      const s = computeStats(filtered);
      const totalInvoiceIncl = inclVat(s.totalInvoiceEx);

      $("totals").innerHTML = `
        <div class="stat"><div class="k">Jobs (udf√∏rt+)</div><div class="v">${s.totalJobs}</div></div>
        <div class="stat"><div class="k">Arbejdstid</div><div class="v">${fmtH(s.totalWorkMin)}</div></div>
        <div class="stat"><div class="k">Transport</div><div class="v">${fmtH(s.totalTravelMin)}</div></div>
        <div class="stat">
          <div class="k">Fakturering ex. moms</div>
          <div class="v">${s.totalInvoiceEx.toFixed(2)}</div>
          <div class="small muted">(${totalInvoiceIncl.toFixed(2)} inkl. moms)</div>
        </div>
      `;

      const stRows = ["planned","completed","invoiced","paid","canceled"].map(k => `
        <tr><td>${escapeHtml(statusLabel(k))}</td><td>${Number(s.statusMap.get(k)||0)}</td></tr>
      `).join("");
      $("byStatus").innerHTML = stRows;

      const monthRows = Array.from(s.monthMap.entries())
        .sort((a,b)=> b[0].localeCompare(a[0]))
        .map(([ym, minutes]) => `
          <tr>
            <td>${escapeHtml(ym)}</td>
            <td>${fmtH(minutes)}</td>
          </tr>
        `).join("");
      $("byMonth").innerHTML = monthRows || `<tr><td colspan="2" class="muted">Ingen data endnu</td></tr>`;
    }

    function filterJobs(){
      const q = $("search").value.trim().toLowerCase();
      const y = $("yearFilter").value;
      const sf = $("statusFilter").value;

      return jobs.filter(j => {
        if (y && String(j.job_date||"").slice(0,4) !== y) return false;
        if (sf && String(j.status||"") !== sf) return false;
        if (!q) return true;

        const hay = [
          j.id, j.client, j.invoice_no, j.category_name,
          String(j.invoice_amount_ex_vat ?? ""),
          j.status
        ].join(" ").toLowerCase();

        return hay.includes(q);
      });
    }

    function renderJobsTable(filtered){
      $("jobsTbody").innerHTML = filtered.map(j => {
        const ex = Number(j.invoice_amount_ex_vat || 0);
        const incl = inclVat(ex);
        const s = j.status || "planned";
        return `
          <tr>
            <td class="mono">${escapeHtml(j.id)}</td>
            <td>
              <span class="pill ${statusPillClass(s)}">${escapeHtml(statusLabel(s))}</span>
            </td>
            <td>${escapeHtml(j.job_date)}</td>
            <td>${escapeHtml(j.client || "")}</td>
            <td><span class="pill">${escapeHtml(j.category_name || "(Ingen)")}</span></td>
            <td>${escapeHtml(j.invoice_no || "")}</td>
            <td>${fmtH(j.work_minutes || 0)}</td>
            <td>${fmtH(j.travel_minutes || 0)}</td>
            <td>
              ${ex ? ex.toFixed(2) : "‚Äî"}<br>
              ${ex ? `<small class="muted">(${incl.toFixed(2)} inkl. moms)</small>` : `<small class="muted">‚Äî</small>`}
            </td>
            <td>
              <button type="button" class="secondary" data-edit="${escapeHtml(j.id)}">Ret</button>
            </td>
          </tr>
        `;
      }).join("");

      document.querySelectorAll("button[data-edit]").forEach(btn => {
        btn.addEventListener("click", () => openEdit(btn.getAttribute("data-edit")));
      });
    }

    function renderPlannedList(){
      const today = todayISO();
      const planned = jobs
        .filter(j => (j.status === "planned") && String(j.job_date||"") >= today)
        .sort((a,b)=> String(a.job_date||"").localeCompare(String(b.job_date||"")))
        .slice(0, 25);

      if (!planned.length){
        $("plannedTbody").innerHTML = `<tr><td colspan="5" class="muted">Ingen kommende planlagte jobs</td></tr>`;
        $("plannedMsg").textContent = "";
        return;
      }

      $("plannedTbody").innerHTML = planned.map(j => `
        <tr>
          <td>${escapeHtml(j.job_date)}</td>
          <td>${escapeHtml(j.client || "")}</td>
          <td><span class="pill">${escapeHtml(j.category_name || "(Ingen)")}</span></td>
          <td><span class="pill plan">Planlagt</span></td>
          <td>
            <button type="button" class="secondary" data-edit="${escapeHtml(j.id)}">Udfyld</button>
          </td>
        </tr>
      `).join("");

      document.querySelectorAll("#plannedTbody button[data-edit]").forEach(btn => {
        btn.addEventListener("click", () => openEdit(btn.getAttribute("data-edit")));
      });

      $("plannedMsg").textContent = "Tip: klik ‚ÄúUdfyld‚Äù for at tilf√∏je tid/bel√∏b og f√• status til at opdatere automatisk.";
    }

    function renderAll(){
      const filtered = filterJobs();
      renderYearFilter();
      renderStats(filtered);
      renderJobsTable(filtered);
    }

    function exportCSV(filtered){
      const header = ["JobID","Status","Dato","Kunde","Kategori","FakturaNr","WorkMin","WorkText","TransportMin","Bel√∏bExMoms","Bel√∏bInclMoms","Noter"];
      const lines = [header.join(",")];

      const esc = (s) => {
        const str = String(s ?? "");
        return /[,"\n]/.test(str) ? `"${str.replace(/"/g,'""')}"` : str;
      };

      for (const j of filtered) {
        const ex = Number(j.invoice_amount_ex_vat || 0);
        const incl = inclVat(ex);
        lines.push([
          esc(j.id),
          esc(j.status),
          esc(j.job_date),
          esc(j.client),
          esc(j.category_name),
          esc(j.invoice_no),
          esc(j.work_minutes),
          esc(j.work_text),
          esc(j.travel_minutes),
          esc(ex ? ex.toFixed(2) : ""),
          esc(ex ? incl.toFixed(2) : ""),
          esc(j.notes),
        ].join(","));
      }

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `rsadm_jobs_${todayISO()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ---------------- REPORT (monthly per client) ----------------
    function setSelectOptions(selectEl, values, placeholder = "(Alle)") {
      const opts = values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      selectEl.innerHTML = `<option value="">${placeholder}</option>` + opts;
    }

    async function loadReportRows(){
      $("reportMsg").textContent = "Henter rapport‚Ä¶";

      const { data, error } = await supabase
        .from("v_monthly_client_report")
        .select("ym,client,jobs,work_minutes,travel_minutes,invoice_ex_vat")
        .eq("user_id", user.id)
        .order("ym", { ascending: false })
        .order("client", { ascending: true });

      if (error) {
        $("reportMsg").textContent = `Fejl: ${error.message}`;
        reportRows = [];
        renderReport();
        return;
      }

      reportRows = data ?? [];
      $("reportMsg").textContent = "";

      const months = Array.from(new Set(reportRows.map(r => r.ym))).sort((a,b)=>b.localeCompare(a));
      const clients = Array.from(new Set(reportRows.map(r => r.client))).sort((a,b)=>a.localeCompare(b));

      setSelectOptions($("reportMonth"), months, "(Alle m√•neder)");
      setSelectOptions($("reportClient"), clients, "(Alle kunder)");

      if (!$("reportMonth").dataset.initialized) {
        $("reportMonth").value = months[0] || "";
        $("reportMonth").dataset.initialized = "1";
      }

      renderReport();
    }

    function getFilteredReportRows(){
      const m = $("reportMonth").value;
      const c = $("reportClient").value;

      return reportRows.filter(r => {
        if (m && r.ym !== m) return false;
        if (c && r.client !== c) return false;
        return true;
      });
    }

    function renderReport(){
      const rows = getFilteredReportRows();

      if (!rows.length) {
        $("reportTbody").innerHTML = `<tr><td colspan="6" class="muted">Ingen rapport-data for det valg</td></tr>`;
        return;
      }

      $("reportTbody").innerHTML = rows.map(r => {
        const ex = Number(r.invoice_ex_vat || 0);
        const incl = inclVat(ex);
        return `
          <tr>
            <td>${escapeHtml(r.ym)}</td>
            <td>${escapeHtml(r.client)}</td>
            <td>${Number(r.jobs || 0)}</td>
            <td>${fmtH(r.work_minutes || 0)}</td>
            <td>${fmtH(r.travel_minutes || 0)}</td>
            <td>
              ${ex.toFixed(2)}<br>
              <small class="muted">(${incl.toFixed(2)} inkl. moms)</small>
            </td>
          </tr>
        `;
      }).join("");
    }

    function exportReportCSV(){
      const rows = getFilteredReportRows();

      const header = ["M√•ned","Kunde","Jobs","WorkMin","WorkTimer","TransportMin","TransportTimer","FaktureringExMoms","FaktureringInclMoms"];
      const lines = [header.join(",")];

      const esc = (s) => {
        const str = String(s ?? "");
        return /[,"\n]/.test(str) ? `"${str.replace(/"/g,'""')}"` : str;
      };

      for (const r of rows) {
        const ex = Number(r.invoice_ex_vat || 0);
        const incl = inclVat(ex);
        lines.push([
          esc(r.ym),
          esc(r.client),
          esc(r.jobs),
          esc(r.work_minutes),
          esc(fmtH(r.work_minutes)),
          esc(r.travel_minutes),
          esc(fmtH(r.travel_minutes)),
          esc(ex.toFixed(2)),
          esc(incl.toFixed(2)),
        ].join(","));
      }

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `rsadm_report_${todayISO()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    // -------------------------------------------------------------

    // AUTH
    async function checkSession(){
      const { data } = await supabase.auth.getSession();
      user = data?.session?.user ?? null;
      setLoggedInUI(!!user);

      if (user) {
        $("jobDate").value = todayISO();
        $("statusSelect").value = "planned";
        applyNewStatusUI();

        await loadCategories();
        await ensureDefaultCategories();
        await loadJobs();
        await loadReportRows();
      }
    }

    $("loginBtn").addEventListener("click", async () => {
      $("loginMsg").textContent = "";
      const email = $("email").value.trim();
      const password = $("password").value;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { $("loginMsg").textContent = error.message; return; }

      user = data.user;
      setLoggedInUI(true);

      $("jobDate").value = todayISO();
      $("statusSelect").value = "planned";
      applyNewStatusUI();

      await loadCategories();
      await ensureDefaultCategories();
      await loadJobs();
      await loadReportRows();
    });

    $("signupBtn").addEventListener("click", async () => {
      $("loginMsg").textContent = "";
      const email = $("email").value.trim();
      const password = $("password").value;

      const { error } = await supabase.auth.signUp({ email, password });
      if (error) { $("loginMsg").textContent = error.message; return; }

      $("loginMsg").textContent = "Bruger oprettet. Log ind med samme email/password.";
    });

    $("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      user = null;
      categories = [];
      jobs = [];
      reportRows = [];
      setLoggedInUI(false);
    });

    // Categories
    $("addCategoryBtn").addEventListener("click", async () => {
      $("catMsg").textContent = "";
      const name = $("newCategory").value.trim();
      if (!name) { $("catMsg").textContent = "Skriv et navn p√• kategorien."; return; }

      const { error } = await supabase.from("categories").insert({ user_id: user.id, name });
      if (error) { $("catMsg").textContent = error.message; return; }

      $("newCategory").value = "";
      $("catMsg").textContent = "Kategori tilf√∏jet ‚úÖ";
      await loadCategories();
      renderAll();
    });

    // Create job
    $("createJobBtn").addEventListener("click", async () => {
      $("jobMsg").textContent = "";

      const invoice_no = $("invoiceNo").value.trim();
      const job_date = $("jobDate").value || todayISO();
      const category_id = $("categorySelect").value || null;
      const client = $("client").value.trim();
      const chosenStatus = $("statusSelect").value;

      if (!client) { $("jobMsg").textContent = "Skriv en kunde."; return; }

      const work_text = $("workText").value.trim();
      const work_minutes = parseWorkMinutes(work_text);

      const travel_minutes = Math.max(0, Number($("travelMinutes").value || 0));
      const invoice_amount_ex_vat = $("invoiceExVat").value === "" ? null : Number($("invoiceExVat").value);
      const notes = $("notes").value.trim() || null;

      const nextStatus = autoStatusFromFields({
        chosenStatus,
        work_minutes,
        invoice_no,
        invoice_amount_ex_vat,
        forcePaid: false
      });

      const stamps = stampsForStatus(nextStatus);

      const { error } = await supabase.from("jobs").insert({
        user_id: user.id,
        invoice_no: (nextStatus === "planned") ? "" : invoice_no,
        job_date,
        category_id,
        client,
        work_minutes: (nextStatus === "planned") ? 0 : work_minutes,
        work_text: (nextStatus === "planned") ? "" : work_text,
        travel_minutes: (nextStatus === "planned") ? 0 : travel_minutes,
        invoice_amount_ex_vat: (nextStatus === "planned") ? null : invoice_amount_ex_vat,
        notes,
        status: nextStatus,
        ...stamps
      });

      if (error) { $("jobMsg").textContent = error.message; return; }

      $("jobMsg").textContent = "Job gemt ‚úÖ";
      resetJobForm();
      await loadJobs();
      await loadReportRows();
    });

    function resetJobForm(){
      $("invoiceNo").value = "";
      $("jobDate").value = todayISO();
      $("statusSelect").value = "planned";
      $("categorySelect").value = "";
      $("client").value = "";
      $("workText").value = "";
      $("travelMinutes").value = "";
      $("invoiceExVat").value = "";
      $("invoiceInclPreview").textContent = "";
      $("notes").value = "";
      applyNewStatusUI();
    }

    $("resetJobBtn").addEventListener("click", resetJobForm);

    // Edit job
    function openEdit(id){
      const j = jobs.find(x => x.id === id);
      if (!j) return;

      editingId = id;
      $("editCard").classList.remove("hidden");
      $("editId").textContent = id;

      $("editStatusSelect").value = j.status ?? "planned";
      $("editInvoiceNo").value = j.invoice_no ?? "";
      $("editJobDate").value = j.job_date ?? todayISO();
      $("editCategorySelect").value = j.category_id ?? "";
      $("editClient").value = j.client ?? "";
      $("editWorkText").value = j.work_text ?? "";
      $("editTravelMinutes").value = j.travel_minutes ?? 0;
      $("editInvoiceExVat").value = j.invoice_amount_ex_vat ?? "";
      $("editNotes").value = j.notes ?? "";

      applyEditStatusUI();
      $("editMsg").textContent = "";
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    }

    $("cancelEditBtn").addEventListener("click", () => {
      editingId = null;
      $("editCard").classList.add("hidden");
    });

    $("saveEditBtn").addEventListener("click", async () => {
      if (!editingId) return;
      $("editMsg").textContent = "";

      const chosenStatus = $("editStatusSelect").value;

      const work_text = $("editWorkText").value.trim();
      const work_minutes = parseWorkMinutes(work_text);

      const invoice_no = $("editInvoiceNo").value.trim();
      const invoice_amount_ex_vat = $("editInvoiceExVat").value === "" ? null : Number($("editInvoiceExVat").value);

      const nextStatus = autoStatusFromFields({
        chosenStatus,
        work_minutes,
        invoice_no,
        invoice_amount_ex_vat,
        forcePaid: (chosenStatus === "paid")
      });

      const stamps = stampsForStatus(nextStatus);

      const patch = {
        status: nextStatus,
        ...stamps,

        invoice_no: (nextStatus === "planned") ? "" : invoice_no,
        job_date: $("editJobDate").value || todayISO(),
        category_id: $("editCategorySelect").value || null,
        client: $("editClient").value.trim(),
        work_text: (nextStatus === "planned") ? "" : work_text,
        work_minutes: (nextStatus === "planned") ? 0 : work_minutes,
        travel_minutes: (nextStatus === "planned") ? 0 : Math.max(0, Number($("editTravelMinutes").value || 0)),
        invoice_amount_ex_vat: (nextStatus === "planned") ? null : invoice_amount_ex_vat,
        notes: $("editNotes").value.trim() || null
      };

      const { error } = await supabase.from("jobs").update(patch).eq("id", editingId);
      if (error) { $("editMsg").textContent = error.message; return; }

      $("editMsg").textContent = "Rettet ‚úÖ";
      await loadJobs();
      await loadReportRows();
      $("editCard").classList.add("hidden");
      editingId = null;
    });

    $("deleteJobBtn").addEventListener("click", async () => {
      if (!editingId) return;
      if (!confirm(`Slet job ${editingId}?`)) return;

      const { error } = await supabase.from("jobs").delete().eq("id", editingId);
      if (error) { $("editMsg").textContent = error.message; return; }

      await loadJobs();
      await loadReportRows();
      $("editCard").classList.add("hidden");
      editingId = null;
    });

    // Filters & actions
    $("refreshBtn").addEventListener("click", async () => { await loadJobs(); await loadReportRows(); });
    $("search").addEventListener("input", renderAll);
    $("yearFilter").addEventListener("change", renderAll);
    $("statusFilter").addEventListener("change", renderAll);

    $("exportBtn").addEventListener("click", () => {
      const filtered = filterJobs();
      exportCSV(filtered);
    });

    // Report actions
    $("reportRefreshBtn").addEventListener("click", loadReportRows);
    $("reportExportBtn").addEventListener("click", exportReportCSV);
    $("reportMonth").addEventListener("change", renderReport);
    $("reportClient").addEventListener("change", renderReport);

    // Invoice previews + status UI
    $("invoiceExVat").addEventListener("input", updateNewInvoicePreview);
    $("editInvoiceExVat").addEventListener("input", updateEditInvoicePreview);
    $("statusSelect").addEventListener("change", applyNewStatusUI);
    $("editStatusSelect").addEventListener("change", applyEditStatusUI);

    // Initial
    await checkSession();

    supabase.auth.onAuthStateChange(async (_event, session) => {
      user = session?.user ?? null;
      setLoggedInUI(!!user);
      if (user) {
        $("jobDate").value = todayISO();
        $("statusSelect").value = "planned";
        applyNewStatusUI();

        await loadCategories();
        await ensureDefaultCategories();
        await loadJobs();
        await loadReportRows();
      }
    });
  </script>
</body>
</html>
