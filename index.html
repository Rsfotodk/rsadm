<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RSADM ‚Äì Job/Faktura tracker</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111b2e;
      --muted:#9fb0d0;
      --text:#e8efff;
      --line:rgba(255,255,255,.10);
      --pri:#6ea8ff;
      --pri2:#3b82f6;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 30% 10%, rgba(110,168,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, rgba(34,197,94,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1120px; margin:0 auto; padding:18px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(17,27,46,.75);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      position: sticky; top: 12px; z-index: 5;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, var(--pri2), #8b5cf6);
      box-shadow: 0 10px 22px rgba(59,130,246,.25);
    }
    .brand h1{font-size:16px; margin:0}
    .muted{color:var(--muted)}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .grid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px}
    .card{
      margin-top:14px;
      background: rgba(17,27,46,.78);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    h2{font-size:16px; margin:0 0 6px 0}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 0}
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(8,13,24,.65);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(110,168,255,.55)}
    button{
      width:auto;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, var(--pri2), var(--pri));
      color: #061021;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(59,130,246,.20);
    }
    button.secondary{
      background: rgba(255,255,255,.08);
      color: var(--text);
      box-shadow:none;
    }
    button.danger{
      background: rgba(239,68,68,.15);
      color: #ffd7d7;
      border-color: rgba(239,68,68,.35);
      box-shadow:none;
    }
    .hidden{display:none !important}
    .small{font-size:12px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    table{
      width:100%;
      border-collapse: collapse;
      margin-top:12px;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
    }
    th,td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align: top;
      font-size:13px;
    }
    th{color:#cfe0ff; font-size:12px; letter-spacing:.02em; background: rgba(0,0,0,.20)}
    tr:hover td{background: rgba(255,255,255,.03)}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      white-space: nowrap;
    }
    .b-draft{border-color:rgba(148,163,184,.35)}
    .b-ready{border-color:rgba(245,158,11,.35); background: rgba(245,158,11,.12)}
    .b-invoiced{border-color:rgba(59,130,246,.35); background: rgba(59,130,246,.12)}
    .b-paid{border-color:rgba(34,197,94,.35); background: rgba(34,197,94,.12)}

    .kpis{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; margin-top:12px}
    .kpi{
      padding:12px; border-radius:16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .kpi .v{font-size:20px; font-weight:800}
    .kpi .l{font-size:12px; color: var(--muted)}

    @media (max-width: 900px){
      .grid{grid-template-columns: 1fr}
      .kpis{grid-template-columns: 1fr 1fr}
      .topbar{position: static}
    }
    @media (max-width: 520px){
      .kpis{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>RSADM</h1>
          <div class="small muted">Fotograf job/faktura tracker</div>
        </div>
      </div>

      <div class="row" style="align-items:center; justify-content:flex-end;">
        <span id="whoami" class="small muted"></span>

        <a href="stats.html" id="statsLink" class="hidden">
          <button class="secondary" type="button">üìä Statistik</button>
        </a>

        <button id="logoutBtn" class="secondary hidden" type="button">Log ud</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h2>Login</h2>

      <div class="grid" style="margin-top:12px;">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="din@email.dk" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="loginBtn" type="button">Log ind</button>
        <button id="signupBtn" type="button" class="secondary">Opret bruger</button>
      </div>

      <p id="loginMsg" class="muted"></p>
      <p class="small muted" style="margin-top:0;">
        Tip: Hvis du f√•r ‚Äúpermission denied‚Äù, s√• tjek RLS policies p√• dine tabeller.
      </p>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">

      <!-- Clients -->
      <div class="card">
        <h2>Kunder</h2>
        <p class="muted">Kunde-master (navn + timepris). Bruges til dropdown p√• jobs.</p>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label>Ny kunde (navn)</label>
            <input id="newClientName" placeholder="fx Seven Racing / AC Horsens" />
          </div>
          <div>
            <label>Timepris (kr. ex. moms)</label>
            <input id="newClientRate" type="number" min="0" step="0.01" placeholder="fx 850.00" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="addClientBtn" type="button">Tilf√∏j kunde</button>
          <button id="refreshClientsBtn" type="button" class="secondary">Opdater liste</button>
        </div>

        <table>
          <thead><tr><th>Kunde</th><th>Timepris</th><th>Handling</th></tr></thead>
          <tbody id="clientsTbody"></tbody>
        </table>

        <p class="muted" id="clientMsg"></p>
        <p class="small muted">Tip: Hvis sletning fejler, er kunden nok i brug af et job (FK). (Vi kan lave ‚Äúarkiv√©r‚Äù senere.)</p>
      </div>

      <!-- Categories -->
      <div class="card">
        <h2>Kategorier</h2>

        <div class="row" style="margin-top:12px;">
          <div style="flex:1 1 320px;">
            <label>Ny kategori</label>
            <input id="newCategory" placeholder="fx Fodbold / H√•ndbold / Klub / Motorsport" />
          </div>
          <div style="display:flex; align-items:flex-end; flex:0 0 auto;">
            <button id="addCategoryBtn" type="button">Tilf√∏j kategori</button>
          </div>
        </div>

        <table>
          <thead><tr><th>Kategori</th><th>Handling</th></tr></thead>
          <tbody id="categoriesTbody"></tbody>
        </table>

        <p class="muted" id="catMsg"></p>
        <p class="small muted" style="margin-top:0;">
          Ved sletning: jobs der bruger kategorien f√•r sat kategori til <span class="mono">NULL</span> og derefter slettes kategorien.
        </p>
      </div>

      <!-- New job -->
      <div class="card">
        <h2>Nyt job</h2>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label>Faktura nummer (dit eget)</label>
            <input id="invoiceNo" placeholder="fx 2025-001 / e-conomic nr." />
          </div>
          <div>
            <label>Dato</label>
            <input id="jobDate" type="date" />
          </div>

          <div>
            <label>Kategori</label>
            <select id="categorySelect"></select>
          </div>

          <div>
            <label>Status</label>
            <select id="statusSelect">
              <option value="draft">draft</option>
              <option value="ready">ready</option>
              <option value="planned">planned</option>
              <option value="invoiced">invoiced</option>
              <option value="paid">paid</option>
            </select>
          </div>

          <div>
            <label>Kunde (v√¶lg fra liste)</label>
            <select id="clientSelect"></select>
            <div class="small muted" id="clientRateHint" style="margin-top:6px;"></div>
          </div>

          <div id="clientManualWrap" class="hidden">
            <label>Kunde (manuel)</label>
            <input id="clientManual" placeholder="fx Seven Racing / AC Horsens" />
          </div>

          <div>
            <label>Tid brugt (minutter / 1:30 / 2t 15m)</label>
            <input id="workText" placeholder="fx 2:15" />
          </div>

          <div>
            <label>Transport total (minutter)</label>
            <input id="travelMinutes" type="number" min="0" step="1" placeholder="fx 90" />
          </div>

          <div>
            <label>Faktur√©r (bel√∏b ex. moms)</label>
            <input id="invoiceExVat" type="number" min="0" step="0.01" placeholder="fx 2000.00" />
            <div class="small muted" id="invoiceInclPreview" style="margin-top:6px;"></div>

            <div class="row" style="margin-top:10px; gap:10px;">
              <label style="display:flex; align-items:center; gap:10px; margin:0;">
                <input id="autoCalcAmount" type="checkbox" checked style="width:auto; transform: translateY(1px);" />
                Beregn bel√∏b automatisk (tid √ó timepris)
              </label>
            </div>
            <div class="small muted" id="autoCalcHint" style="margin-top:6px;"></div>
          </div>

          <div>
            <label>Noter</label>
            <input id="notes" placeholder="fx levering / s√¶rlige aftaler" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="createJobBtn" type="button">Gem job</button>
          <button id="resetJobBtn" type="button" class="secondary">Nulstil</button>
        </div>

        <p class="muted" id="jobMsg"></p>
      </div>

      <!-- Jobs list -->
      <div class="card">
        <h2>Jobs</h2>

        <div class="row" style="margin-top:12px; align-items:flex-end; justify-content:space-between;">
          <div style="display:flex; gap:10px; flex-wrap:wrap; flex:1 1 auto;">
            <div style="min-width: 220px;">
              <label>S√∏g (kunde/faktura/noter)</label>
              <input id="search" placeholder="fx Horsens / 2025- / bryllup" />
            </div>
            <div style="min-width: 160px;">
              <label>√Ör</label>
              <select id="yearFilter"></select>
            </div>
            <div style="min-width: 160px;">
              <label>Status</label>
              <select id="statusFilter">
                <option value="">Alle</option>
                <option value="draft">draft</option>
                <option value="ready">ready</option>
                <option value="planned">planned</option>
                <option value="invoiced">invoiced</option>
                <option value="paid">paid</option>
              </select>
            </div>
          </div>

          <div style="display:flex; gap:10px; align-items:flex-end; flex:0 0 auto;">
            <button id="refreshBtn" type="button" class="secondary">Opdater</button>
            <button id="exportBtn" type="button">Eksport CSV</button>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="v" id="kpiJobs">0</div><div class="l">Jobs</div></div>
          <div class="kpi"><div class="v" id="kpiWork">0:00</div><div class="l">Arbejdstid</div></div>
          <div class="kpi"><div class="v" id="kpiTravel">0:00</div><div class="l">Transport</div></div>
          <div class="kpi"><div class="v" id="kpiInv">0.00</div><div class="l">Fakturering ex. moms</div></div>
        </div>

        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Dato</th>
              <th>Status</th>
              <th>Kunde</th>
              <th>Kategori</th>
              <th>Faktura nr</th>
              <th>Tid</th>
              <th>Transport</th>
              <th>Bel√∏b ex. moms</th>
              <th>Handling</th>
            </tr>
          </thead>
          <tbody id="jobsTbody"></tbody>
        </table>

        <p class="muted" id="tableMsg"></p>
      </div>

      <!-- Report -->
      <div class="card">
        <h2>M√•nedsrapport pr. kunde</h2>
        <p class="muted">K√∏rer fra view <span class="mono">v_monthly_client_report</span>.</p>

        <div class="row" style="margin-top:12px; align-items:flex-end;">
          <div style="min-width: 200px;">
            <label>M√•ned</label>
            <select id="reportMonth"></select>
          </div>
          <div style="min-width: 260px;">
            <label>Kunde</label>
            <select id="reportClient"></select>
          </div>

          <div style="display:flex; gap:10px;">
            <button id="reportRefreshBtn" type="button" class="secondary">Opdater</button>
            <button id="reportExportBtn" type="button">Eksport CSV</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>M√•ned</th>
              <th>Kunde</th>
              <th>Jobs</th>
              <th>Arbejdstid</th>
              <th>Transport</th>
              <th>Fakturering</th>
            </tr>
          </thead>
          <tbody id="reportTbody"></tbody>
        </table>

        <p class="muted" id="reportMsg"></p>
      </div>

      <!-- Edit -->
      <div id="editCard" class="card hidden">
        <h2>Ret job <span id="editId" class="mono"></span></h2>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label>Faktura nummer</label>
            <input id="editInvoiceNo" />
          </div>
          <div>
            <label>Dato</label>
            <input id="editJobDate" type="date" />
          </div>

          <div>
            <label>Kategori</label>
            <select id="editCategorySelect"></select>
          </div>

          <div>
            <label>Status</label>
            <select id="editStatusSelect">
              <option value="draft">draft</option>
              <option value="ready">ready</option>
              <option value="planned">planned</option>
              <option value="invoiced">invoiced</option>
              <option value="paid">paid</option>
            </select>
          </div>

          <div>
            <label>Kunde (v√¶lg fra liste)</label>
            <select id="editClientSelect"></select>
            <div class="small muted" id="editClientRateHint" style="margin-top:6px;"></div>
          </div>

          <div id="editClientManualWrap" class="hidden">
            <label>Kunde (manuel)</label>
            <input id="editClientManual" />
          </div>

          <div>
            <label>Tid brugt (tekst)</label>
            <input id="editWorkText" />
          </div>

          <div>
            <label>Transport total (min)</label>
            <input id="editTravelMinutes" type="number" min="0" step="1" />
          </div>

          <div>
            <label>Bel√∏b ex. moms</label>
            <input id="editInvoiceExVat" type="number" min="0" step="0.01" />
            <div class="small muted" id="editInvoiceInclPreview" style="margin-top:6px;"></div>

            <label style="display:flex; align-items:center; gap:10px; margin-top:10px;">
              <input id="editAutoCalcAmount" type="checkbox" checked style="width:auto; transform: translateY(1px);" />
              Beregn bel√∏b automatisk
            </label>
            <div class="small muted" id="editAutoCalcHint" style="margin-top:6px;"></div>
          </div>

          <div style="grid-column: 1 / -1;">
            <label>Noter</label>
            <textarea id="editNotes"></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="saveEditBtn" type="button">Gem √¶ndringer</button>
          <button id="cancelEditBtn" type="button" class="secondary">Annuller</button>
          <button id="deleteJobBtn" type="button" class="danger">Slet job</button>
        </div>

        <p class="muted" id="editMsg"></p>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ------------------ SUPABASE ------------------
    const SUPABASE_URL = "https://epzbdezmbyyduqjthdzt.supabase.co";
    const SUPABASE_ANON_KEY = "SUPABASE_ANON_KEY_HERE"; // <-- inds√¶t din anon key
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // --------------------------------------------

    const $ = (id) => document.getElementById(id);

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function parseWorkMinutes(input){
      const s = String(input ?? "").trim().toLowerCase();
      if (!s) return 0;

      const colon = s.match(/^(\d+)\s*:\s*(\d{1,2})$/);
      if (colon) return Number(colon[1])*60 + Number(colon[2]);

      const onlyNum = s.match(/^\d+$/);
      if (onlyNum) return Number(s);

      let total = 0;
      const h = s.match(/(\d+)\s*(t|h|timer|time)/);
      const m = s.match(/(\d+)\s*(m|min|minutter|minute)/);
      if (h) total += Number(h[1]) * 60;
      if (m) total += Number(m[1]);
      return total;
    }

    function fmtH(mins){
      const m = Math.max(0, Number(mins || 0));
      const h = Math.floor(m / 60);
      const mm = String(m % 60).padStart(2,"0");
      return `${h}:${mm}`;
    }

    function inclVat(ex){
      const n = Number(ex || 0);
      return n * 1.25;
    }

    function round2(n){
      const x = Number(n || 0);
      return Math.round(x * 100) / 100;
    }

    function statusBadge(status){
      const s = String(status || "draft");
      const cls =
        s === "ready" ? "b-ready" :
        s === "planned" ? "b-ready" :
        s === "invoiced" ? "b-invoiced" :
        s === "paid" ? "b-paid" :
        "b-draft";
      return `<span class="badge ${cls}">${escapeHtml(s)}</span>`;
    }

    // ------------------ STATE ------------------
    let user = null;
    let categories = [];
    let clients = [];
    let jobs = [];
    let reportRows = [];
    let editingId = null;

    function setLoggedInUI(isIn){
      $("loginCard").classList.toggle("hidden", isIn);
      $("app").classList.toggle("hidden", !isIn);
      $("logoutBtn").classList.toggle("hidden", !isIn);
      $("statsLink")?.classList.toggle("hidden", !isIn);
      $("whoami").textContent = isIn ? `Logget ind: ${user?.email ?? ""}` : "";
    }

    function updateNewInvoicePreview(){
      const ex = $("invoiceExVat").value === "" ? null : Number($("invoiceExVat").value);
      $("invoiceInclPreview").textContent = ex === null ? "" : `= ${inclVat(ex).toFixed(2)} inkl. moms`;
    }

    function updateEditInvoicePreview(){
      const ex = $("editInvoiceExVat").value === "" ? null : Number($("editInvoiceExVat").value);
      $("editInvoiceInclPreview").textContent = ex === null ? "" : `= ${inclVat(ex).toFixed(2)} inkl. moms`;
    }

    function getClientById(id){
      if (!id) return null;
      return clients.find(c => c.id === id) || null;
    }

    function updateClientManualVisibility(){
      const id = $("clientSelect").value || "";
      $("clientManualWrap").classList.toggle("hidden", !!id);
      if (id) $("clientManual").value = "";
    }

    function updateEditClientManualVisibility(){
      const id = $("editClientSelect").value || "";
      $("editClientManualWrap").classList.toggle("hidden", !!id);
      if (id) $("editClientManual").value = "";
    }

    function updateClientRateHints(){
      const c = getClientById($("clientSelect").value);
      $("clientRateHint").textContent = c?.hourly_rate != null ? `Timepris: ${Number(c.hourly_rate).toFixed(2)} kr ex. moms` : "";
    }

    function updateEditClientRateHints(){
      const c = getClientById($("editClientSelect").value);
      $("editClientRateHint").textContent = c?.hourly_rate != null ? `Timepris: ${Number(c.hourly_rate).toFixed(2)} kr ex. moms` : "";
    }

    function maybeAutoCalcNewAmount(){
      const auto = $("autoCalcAmount").checked;
      const c = getClientById($("clientSelect").value);
      const mins = parseWorkMinutes($("workText").value);
      if (!auto) { $("autoCalcHint").textContent = "Auto-beregning er sl√•et fra."; return; }

      if (!c || c.hourly_rate == null || Number(c.hourly_rate) <= 0) {
        $("autoCalcHint").textContent = "V√¶lg en kunde med timepris for auto-beregning (eller indtast bel√∏b manuelt).";
        return;
      }
      const amount = round2((mins / 60) * Number(c.hourly_rate));
      $("invoiceExVat").value = mins ? amount.toFixed(2) : "";
      $("autoCalcHint").textContent = mins ? `Auto: ${fmtH(mins)} √ó ${Number(c.hourly_rate).toFixed(2)} = ${amount.toFixed(2)} kr ex. moms` : "Skriv tid for at beregne bel√∏b.";
      updateNewInvoicePreview();
    }

    function maybeAutoCalcEditAmount(){
      const auto = $("editAutoCalcAmount").checked;
      const c = getClientById($("editClientSelect").value);
      const mins = parseWorkMinutes($("editWorkText").value);
      if (!auto) { $("editAutoCalcHint").textContent = "Auto-beregning er sl√•et fra."; return; }

      if (!c || c.hourly_rate == null || Number(c.hourly_rate) <= 0) {
        $("editAutoCalcHint").textContent = "V√¶lg en kunde med timepris for auto-beregning (eller indtast bel√∏b manuelt).";
        return;
      }
      const amount = round2((mins / 60) * Number(c.hourly_rate));
      $("editInvoiceExVat").value = mins ? amount.toFixed(2) : "";
      $("editAutoCalcHint").textContent = mins ? `Auto: ${fmtH(mins)} √ó ${Number(c.hourly_rate).toFixed(2)} = ${amount.toFixed(2)} kr ex. moms` : "Skriv tid for at beregne bel√∏b.";
      updateEditInvoicePreview();
    }

    // ------------------ CATEGORIES ------------------
    async function ensureDefaultCategories(){
      if (categories.length) return;
      const starter = ["Fodbold","H√•ndbold","Klub","Motorsport","Event","Bryllup","Studio"];
      const inserts = starter.map(name => ({ user_id: user.id, name }));
      const { error } = await supabase.from("categories").insert(inserts);
      if (error) console.warn(error);
      await loadCategories();
    }

    async function loadCategories(){
      const { data, error } = await supabase
        .from("categories")
        .select("id,name")
        .order("name", { ascending: true });

      if (error) {
        $("catMsg").textContent = `Fejl ved hentning af kategorier: ${error.message}`;
        categories = [];
        renderCategorySelects();
        renderCategoriesTable();
        return;
      }

      categories = data ?? [];
      $("catMsg").textContent = "";
      renderCategorySelects();
      renderCategoriesTable();
    }

    function renderCategorySelects(){
      const opts = (categories || []).map(c => `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join("");
      $("categorySelect").innerHTML = `<option value="">(V√¶lg)</option>` + opts;
      $("editCategorySelect").innerHTML = `<option value="">(V√¶lg)</option>` + opts;
    }

    function renderCategoriesTable(){
      $("categoriesTbody").innerHTML = (categories || []).map(c => `
        <tr>
          <td>${escapeHtml(c.name)}</td>
          <td><button type="button" class="secondary" data-del-cat="${escapeHtml(c.id)}">Slet</button></td>
        </tr>
      `).join("") || `<tr><td colspan="2" class="muted">Ingen kategorier endnu</td></tr>`;

      document.querySelectorAll("button[data-del-cat]").forEach(btn => {
        btn.addEventListener("click", () => deleteCategory(btn.getAttribute("data-del-cat")));
      });
    }

    async function deleteCategory(id){
      if (!id) return;

      const cat = categories.find(c => c.id === id);
      const name = cat?.name || "kategorien";

      if (!confirm(`Slet "${name}"?\n\nOBS: Jobs der bruger kategorien f√•r sat kategori til (Ingen).`)) return;

      $("catMsg").textContent = "";

      // 1) frig√∏r FK ved at s√¶tte jobs.category_id = null
      const { error: jobsErr } = await supabase
        .from("jobs")
        .update({ category_id: null })
        .eq("category_id", id);

      if (jobsErr) { $("catMsg").textContent = `Fejl (jobs update): ${jobsErr.message}`; return; }

      // 2) slet kategorien
      const { error: delErr } = await supabase
        .from("categories")
        .delete()
        .eq("id", id);

      if (delErr) { $("catMsg").textContent = `Fejl (slet kategori): ${delErr.message}`; return; }

      $("catMsg").textContent = "Kategori slettet ‚úÖ";
      await loadCategories();
      await loadJobs();
      await loadReportRows();
    }

    // ------------------ CLIENTS ------------------
    async function loadClients(){
      const { data, error } = await supabase
        .from("clients")
        .select("id,name,hourly_rate")
        .order("name", { ascending: true });

      if (error) {
        $("clientMsg").textContent = `Fejl ved hentning af kunder: ${error.message}`;
        clients = [];
        renderClientSelects();
        renderClientsTable();
        return;
      }

      clients = data ?? [];
      $("clientMsg").textContent = "";
      renderClientSelects();
      renderClientsTable();
    }

    function renderClientSelects(){
      const opts = (clients || []).map(c => `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join("");
      $("clientSelect").innerHTML = `<option value="">(V√¶lg)</option>` + opts;
      $("editClientSelect").innerHTML = `<option value="">(V√¶lg)</option>` + opts;
      updateClientManualVisibility();
      updateEditClientManualVisibility();
      updateClientRateHints();
      updateEditClientRateHints();
    }

    function renderClientsTable(){
      $("clientsTbody").innerHTML = (clients || []).map(c => `
        <tr>
          <td>${escapeHtml(c.name)}</td>
          <td>${c.hourly_rate == null ? "" : Number(c.hourly_rate).toFixed(2)}</td>
          <td><button type="button" class="secondary" data-del-client="${escapeHtml(c.id)}">Slet</button></td>
        </tr>
      `).join("") || `<tr><td colspan="3" class="muted">Ingen kunder endnu</td></tr>`;

      document.querySelectorAll("button[data-del-client]").forEach(btn => {
        btn.addEventListener("click", () => deleteClient(btn.getAttribute("data-del-client")));
      });
    }

    async function deleteClient(id){
      if (!id) return;
      if (!confirm("Slet kunde? (kan fejle hvis kunden bruges af jobs)")) return;

      const { error } = await supabase.from("clients").delete().eq("id", id);
      if (error) { $("clientMsg").textContent = error.message; return; }

      $("clientMsg").textContent = "Kunde slettet ‚úÖ";
      await loadClients();
      await loadJobs();
      await loadReportRows();
    }

    // ------------------ JOBS ------------------
    async function loadJobs(){
      const { data, error } = await supabase
        .from("jobs")
        .select(`
          id, job_date, status,
          client, client_id,
          invoice_no, work_minutes, work_text, travel_minutes, invoice_amount_ex_vat, notes,
          category_id,
          categories(name),
          clients(name,hourly_rate)
        `)
        .order("job_date", { ascending: false })
        .order("created_at", { ascending: false });

      if (error) {
        $("tableMsg").textContent = `Fejl ved hentning af jobs: ${error.message}`;
        jobs = [];
        renderAll();
        return;
      }

      jobs = (data ?? []).map(r => ({
        ...r,
        status: r.status || "draft",
        category_name: r.categories?.name ?? "",
        client_name: r.clients?.name ?? r.client ?? "",
        client_rate: r.clients?.hourly_rate ?? null
      }));

      $("tableMsg").textContent = "";
      renderAll();
    }

    function filterJobs(){
      const q = ($("search").value || "").trim().toLowerCase();
      const year = $("yearFilter").value || "";
      const st = $("statusFilter").value || "";

      return (jobs || []).filter(j => {
        const s = `${j.client_name||""} ${j.invoice_no||""} ${j.notes||""}`.toLowerCase();
        if (q && !s.includes(q)) return false;
        if (year && String(j.job_date||"").slice(0,4) !== year) return false;
        if (st && String(j.status||"") !== st) return false;
        return true;
      });
    }

    function renderYearFilter(){
      const years = Array.from(new Set((jobs||[]).map(j => String(j.job_date || "").slice(0,4)).filter(Boolean)))
        .sort((a,b)=>b.localeCompare(a));
      const cur = $("yearFilter").value;
      $("yearFilter").innerHTML = `<option value="">Alle</option>` + years.map(y=>`<option value="${y}">${y}</option>`).join("");
      if (years.includes(cur)) $("yearFilter").value = cur;
    }

    function computeStats(filtered){
      const totalJobs = filtered.length;
      const totalWorkMin = filtered.reduce((a,j)=>a+(Number(j.work_minutes)||0),0);
      const totalTravelMin = filtered.reduce((a,j)=>a+(Number(j.travel_minutes)||0),0);
      const totalInvoiceEx = filtered.reduce((a,j)=>a+(Number(j.invoice_amount_ex_vat)||0),0);
      return { totalJobs, totalWorkMin, totalTravelMin, totalInvoiceEx };
    }

    function renderStats(filtered){
      const s = computeStats(filtered);
      $("kpiJobs").textContent = String(s.totalJobs);
      $("kpiWork").textContent = fmtH(s.totalWorkMin);
      $("kpiTravel").textContent = fmtH(s.totalTravelMin);
      $("kpiInv").textContent = Number(s.totalInvoiceEx).toFixed(2);
    }

    function renderJobsTable(filtered){
      $("jobsTbody").innerHTML = filtered.map(j => `
        <tr>
          <td class="mono">${escapeHtml(j.id)}</td>
          <td>${escapeHtml(j.job_date || "")}</td>
          <td>${statusBadge(j.status)}</td>
          <td>${escapeHtml(j.client_name || "")}</td>
          <td>${escapeHtml(j.category_name || "(Ingen)")}</td>
          <td>${escapeHtml(j.invoice_no || "")}</td>
          <td>${fmtH(j.work_minutes || 0)}<br><span class="small muted">${escapeHtml(j.work_text || "")}</span></td>
          <td>${fmtH(j.travel_minutes || 0)}</td>
          <td>
            ${Number(j.invoice_amount_ex_vat || 0).toFixed(2)}<br>
            <span class="small muted">(${inclVat(Number(j.invoice_amount_ex_vat||0)).toFixed(2)} inkl.)</span>
          </td>
          <td><button type="button" class="secondary" data-edit="${escapeHtml(j.id)}">Ret</button></td>
        </tr>
      `).join("") || `<tr><td colspan="10" class="muted">Ingen jobs matcher filter</td></tr>`;

      document.querySelectorAll("button[data-edit]").forEach(b=>{
        b.addEventListener("click", ()=>openEdit(b.getAttribute("data-edit")));
      });
    }

    function renderAll(){
      renderYearFilter();
      const filtered = filterJobs();
      renderStats(filtered);
      renderJobsTable(filtered);
    }

    function resetJobForm(){
      $("invoiceNo").value = "";
      $("jobDate").value = todayISO();
      $("categorySelect").value = "";
      $("statusSelect").value = "draft";
      $("clientSelect").value = "";
      $("clientManual").value = "";
      updateClientManualVisibility();
      updateClientRateHints();
      $("workText").value = "";
      $("travelMinutes").value = "";
      $("invoiceExVat").value = "";
      $("invoiceInclPreview").textContent = "";
      $("notes").value = "";
      $("jobMsg").textContent = "";
      $("autoCalcHint").textContent = "";
    }

    function openEdit(id){
      const j = (jobs || []).find(x => String(x.id) === String(id));
      if (!j) return;

      editingId = j.id;
      $("editCard").classList.remove("hidden");
      $("editId").textContent = j.id;

      $("editInvoiceNo").value = j.invoice_no ?? "";
      $("editJobDate").value = j.job_date ?? todayISO();
      $("editCategorySelect").value = j.category_id ?? "";
      $("editStatusSelect").value = j.status ?? "draft";

      $("editClientSelect").value = j.client_id ?? "";
      $("editClientManual").value = (j.client_id ? "" : (j.client ?? ""));
      updateEditClientManualVisibility();
      updateEditClientRateHints();

      $("editWorkText").value = j.work_text ?? "";
      $("editTravelMinutes").value = j.travel_minutes ?? 0;
      $("editInvoiceExVat").value = j.invoice_amount_ex_vat ?? "";
      $("editNotes").value = j.notes ?? "";

      updateEditInvoicePreview();
      $("editMsg").textContent = "";
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });

      maybeAutoCalcEditAmount();
    }

    // ------------------ REPORT ------------------
    async function loadReportRows(){
      $("reportMsg").textContent = "";
      const { data, error } = await supabase
        .from("v_monthly_client_report")
        .select("ym,client,jobs,work_minutes,travel_minutes,invoice_ex_vat")
        .eq("user_id", user.id)
        .order("ym", { ascending:false })
        .order("client", { ascending:true });

      if (error) {
        $("reportMsg").textContent = `Fejl ved hentning af rapport: ${error.message}`;
        reportRows = [];
        renderReportFilters();
        renderReport();
        return;
      }

      reportRows = data ?? [];
      renderReportFilters();
      renderReport();
    }

    function renderReportFilters(){
      const months = Array.from(new Set((reportRows||[]).map(r=>r.ym).filter(Boolean))).sort((a,b)=>b.localeCompare(a));
      const clientsU = Array.from(new Set((reportRows||[]).map(r=>r.client).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

      const curM = $("reportMonth").value;
      const curC = $("reportClient").value;

      $("reportMonth").innerHTML = `<option value="">Alle</option>` + months.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("");
      $("reportClient").innerHTML = `<option value="">Alle</option>` + clientsU.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

      if (months.includes(curM)) $("reportMonth").value = curM;
      if (clientsU.includes(curC)) $("reportClient").value = curC;
    }

    function getFilteredReportRows(){
      const m = $("reportMonth").value || "";
      const c = $("reportClient").value || "";
      return (reportRows||[]).filter(r=>{
        if (m && r.ym !== m) return false;
        if (c && r.client !== c) return false;
        return true;
      });
    }

    function renderReport(){
      const rows = getFilteredReportRows();

      if (!rows.length) {
        $("reportTbody").innerHTML = `<tr><td colspan="6" class="muted">Ingen rapport-data for det valg</td></tr>`;
        return;
      }

      $("reportTbody").innerHTML = rows.map(r => {
        const ex = Number(r.invoice_ex_vat || 0);
        const incl = inclVat(ex);
        return `
          <tr>
            <td>${escapeHtml(r.ym)}</td>
            <td>${escapeHtml(r.client)}</td>
            <td>${Number(r.jobs || 0)}</td>
            <td>${fmtH(r.work_minutes || 0)}</td>
            <td>${fmtH(r.travel_minutes || 0)}</td>
            <td>
              ${ex.toFixed(2)}<br>
              <small class="muted">(${incl.toFixed(2)} inkl. moms)</small>
            </td>
          </tr>
        `;
      }).join("");
    }

    function exportCSV(rows){
      const header = ["ID","Dato","Status","Kunde","Kategori","FakturaNr","WorkMin","WorkTimer","WorkText","TransportMin","TransportTimer","Bel√∏bExMoms","Bel√∏bInclMoms","Noter"];
      const lines = [header.join(",")];

      const esc = (s) => {
        const str = String(s ?? "");
        return /[,"\n]/.test(str) ? `"${str.replace(/"/g,'""')}"` : str;
      };

      rows.forEach(j=>{
        const ex = Number(j.invoice_amount_ex_vat || 0);
        const incl = inclVat(ex);
        lines.push([
          esc(j.id),
          esc(j.job_date),
          esc(j.status),
          esc(j.client_name || j.client || ""),
          esc(j.category_name || ""),
          esc(j.invoice_no || ""),
          esc(j.work_minutes || 0),
          esc(fmtH(j.work_minutes || 0)),
          esc(j.work_text || ""),
          esc(j.travel_minutes || 0),
          esc(fmtH(j.travel_minutes || 0)),
          esc(ex.toFixed(2)),
          esc(incl.toFixed(2)),
          esc(j.notes || ""),
        ].join(","));
      });

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `rsadm_jobs_${todayISO()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportReportCSV(){
      const rows = getFilteredReportRows();
      const header = ["M√•ned","Kunde","Jobs","WorkMin","WorkTimer","TransportMin","TransportTimer","FaktureringExMoms","FaktureringInclMoms"];
      const lines = [header.join(",")];

      const esc = (s) => {
        const str = String(s ?? "");
        return /[,"\n]/.test(str) ? `"${str.replace(/"/g,'""')}"` : str;
      };

      for (const r of rows) {
        const ex = Number(r.invoice_ex_vat || 0);
        const incl = inclVat(ex);
        lines.push([
          esc(r.ym),
          esc(r.client),
          esc(r.jobs),
          esc(r.work_minutes),
          esc(fmtH(r.work_minutes)),
          esc(r.travel_minutes),
          esc(fmtH(r.travel_minutes)),
          esc(ex.toFixed(2)),
          esc(incl.toFixed(2)),
        ].join(","));
      }

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `rsadm_report_${todayISO()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ------------------ AUTH ------------------
    async function checkSession(){
      const { data } = await supabase.auth.getSession();
      user = data?.session?.user ?? null;
      setLoggedInUI(!!user);

      if (user) {
        $("jobDate").value = todayISO();
        $("statusSelect").value = "draft";
        await loadClients();
        await loadCategories();
        await ensureDefaultCategories();
        await loadJobs();
        await loadReportRows();
      }
    }

    // ------------------ EVENTS ------------------
    $("loginBtn").addEventListener("click", async () => {
      $("loginMsg").textContent = "";
      const email = $("email").value.trim();
      const password = $("password").value;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { $("loginMsg").textContent = error.message; return; }

      user = data.user;
      setLoggedInUI(true);
      $("jobDate").value = todayISO();
      $("statusSelect").value = "draft";
      await loadClients();
      await loadCategories();
      await ensureDefaultCategories();
      await loadJobs();
      await loadReportRows();
    });

    $("signupBtn").addEventListener("click", async () => {
      $("loginMsg").textContent = "";
      const email = $("email").value.trim();
      const password = $("password").value;

      const { error } = await supabase.auth.signUp({ email, password });
      if (error) { $("loginMsg").textContent = error.message; return; }

      $("loginMsg").textContent = "Bruger oprettet. Log ind med samme email/password.";
    });

    $("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      user = null;
      categories = [];
      clients = [];
      jobs = [];
      reportRows = [];
      setLoggedInUI(false);
    });

    // Clients
    $("addClientBtn").addEventListener("click", async () => {
      $("clientMsg").textContent = "";
      const name = $("newClientName").value.trim();
      const hourly_rate = $("newClientRate").value === "" ? null : Number($("newClientRate").value);

      if (!name) { $("clientMsg").textContent = "Skriv et kundenavn."; return; }

      const { error } = await supabase
        .from("clients")
        .insert({ user_id: user.id, name, hourly_rate });

      if (error) { $("clientMsg").textContent = error.message; return; }

      $("newClientName").value = "";
      $("newClientRate").value = "";
      $("clientMsg").textContent = "Kunde tilf√∏jet ‚úÖ";
      await loadClients();
    });

    $("refreshClientsBtn").addEventListener("click", loadClients);

    // Categories
    $("addCategoryBtn").addEventListener("click", async () => {
      $("catMsg").textContent = "";
      const name = $("newCategory").value.trim();
      if (!name) { $("catMsg").textContent = "Skriv et navn p√• kategorien."; return; }

      const { error } = await supabase.from("categories").insert({ user_id: user.id, name });
      if (error) { $("catMsg").textContent = error.message; return; }

      $("newCategory").value = "";
      $("catMsg").textContent = "Kategori tilf√∏jet ‚úÖ";
      await loadCategories();
      renderAll();
    });

    // Create job
    $("createJobBtn").addEventListener("click", async () => {
      $("jobMsg").textContent = "";

      const invoice_no = $("invoiceNo").value.trim();
      const job_date = $("jobDate").value || todayISO();
      const category_id = $("categorySelect").value || null;
      const status = $("statusSelect").value || "draft";

      const client_id = $("clientSelect").value || null;
      const client = client_id ? (getClientById(client_id)?.name || null) : ($("clientManual").value.trim() || null);

      const work_text = $("workText").value.trim();
      const work_minutes = parseWorkMinutes(work_text);

      const travel_minutes = Math.max(0, Number($("travelMinutes").value || 0));
      const invoice_amount_ex_vat = $("invoiceExVat").value === "" ? null : Number($("invoiceExVat").value);
      const notes = $("notes").value.trim() || null;

      const { error } = await supabase.from("jobs").insert({
        user_id: user.id,
        invoice_no,
        job_date,
        category_id,
        status,
        client_id,
        client,
        work_minutes,
        work_text,
        travel_minutes,
        invoice_amount_ex_vat,
        notes
      });

      if (error) { $("jobMsg").textContent = error.message; return; }

      $("jobMsg").textContent = "Job gemt ‚úÖ";
      resetJobForm();
      await loadJobs();
      await loadReportRows();
    });

    $("resetJobBtn").addEventListener("click", resetJobForm);

    // Edit job actions
    $("cancelEditBtn").addEventListener("click", () => {
      editingId = null;
      $("editCard").classList.add("hidden");
    });

    $("saveEditBtn").addEventListener("click", async () => {
      if (!editingId) return;
      $("editMsg").textContent = "";

      const work_text = $("editWorkText").value.trim();
      const work_minutes = parseWorkMinutes(work_text);

      const client_id = $("editClientSelect").value || null;
      const client = client_id ? (getClientById(client_id)?.name || null) : ($("editClientManual").value.trim() || null);

      const patch = {
        invoice_no: $("editInvoiceNo").value.trim(),
        job_date: $("editJobDate").value || todayISO(),
        category_id: $("editCategorySelect").value || null,
        status: $("editStatusSelect").value || "draft",
        client_id,
        client,
        work_text,
        work_minutes,
        travel_minutes: Math.max(0, Number($("editTravelMinutes").value || 0)),
        invoice_amount_ex_vat: $("editInvoiceExVat").value === "" ? null : Number($("editInvoiceExVat").value),
        notes: ($("editNotes").value || "").trim() || null
      };

      const { error } = await supabase.from("jobs").update(patch).eq("id", editingId);
      if (error) { $("editMsg").textContent = error.message; return; }

      $("editMsg").textContent = "Rettet ‚úÖ";
      await loadJobs();
      await loadReportRows();
      $("editCard").classList.add("hidden");
      editingId = null;
    });

    $("deleteJobBtn").addEventListener("click", async () => {
      if (!editingId) return;
      if (!confirm(`Slet job ${editingId}?`)) return;

      const { error } = await supabase.from("jobs").delete().eq("id", editingId);
      if (error) { $("editMsg").textContent = error.message; return; }

      await loadJobs();
      await loadReportRows();
      $("editCard").classList.add("hidden");
      editingId = null;
    });

    // Filters & actions
    $("refreshBtn").addEventListener("click", async () => { await loadClients(); await loadJobs(); await loadReportRows(); });
    $("search").addEventListener("input", renderAll);
    $("yearFilter").addEventListener("change", renderAll);
    $("statusFilter").addEventListener("change", renderAll);

    $("exportBtn").addEventListener("click", () => exportCSV(filterJobs()));

    // Report actions
    $("reportRefreshBtn").addEventListener("click", loadReportRows);
    $("reportExportBtn").addEventListener("click", exportReportCSV);
    $("reportMonth").addEventListener("change", renderReport);
    $("reportClient").addEventListener("change", renderReport);

    // Invoice previews + auto calc (NEW)
    $("invoiceExVat").addEventListener("input", updateNewInvoicePreview);
    $("workText").addEventListener("input", () => { maybeAutoCalcNewAmount(); });
    $("autoCalcAmount").addEventListener("change", () => { maybeAutoCalcNewAmount(); });
    $("clientSelect").addEventListener("change", () => {
      updateClientManualVisibility();
      updateClientRateHints();
      maybeAutoCalcNewAmount();
    });

    // Invoice previews + auto calc (EDIT)
    $("editInvoiceExVat").addEventListener("input", updateEditInvoicePreview);
    $("editWorkText").addEventListener("input", () => { maybeAutoCalcEditAmount(); });
    $("editAutoCalcAmount").addEventListener("change", () => { maybeAutoCalcEditAmount(); });
    $("editClientSelect").addEventListener("change", () => {
      updateEditClientManualVisibility();
      updateEditClientRateHints();
      maybeAutoCalcEditAmount();
    });

    // INIT
    await checkSession();

    supabase.auth.onAuthStateChange(async (_event, session) => {
      user = session?.user ?? null;
      setLoggedInUI(!!user);
      if (user) {
        $("jobDate").value = todayISO();
        $("statusSelect").value = "draft";
        await loadClients();
        await loadCategories();
        await ensureDefaultCategories();
        await loadJobs();
        await loadReportRows();
      }
    });
  </script>
</body>
</html>
