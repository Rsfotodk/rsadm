<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RSADM ‚Äì Job & Faktura Overblik</title>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;700;900&family=Space+Mono:wght@400;700&display=swap");

    :root{
      --maxw: 1200px;
      --pad: 18px;

      --bg:#f2efe8;
      --bg-soft:#e9e3d6;
      --card:#fbf8f1;
      --card2:#f0eadc;
      --line:#1d1d1b;

      --text:#11110f;
      --muted:#4b463f;
      --muted2:#6b655c;

      --accent:#c43c2d;
      --accent2:#0f766e;

      --danger:#b91c1c;
      --shadow: 8px 8px 0 rgba(29,29,27,1);
      --radius: 6px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: "Fraunces", "Iowan Old Style", serif;
      color:var(--text);
      background:
        linear-gradient(0deg, rgba(0,0,0,.025), rgba(0,0,0,.025)),
        repeating-linear-gradient(135deg, rgba(0,0,0,.03) 0 2px, transparent 2px 6px),
        linear-gradient(180deg, var(--bg), var(--bg-soft));
    }

    .wrap{
      max-width: var(--maxw);
      margin: 18px auto 40px;
      padding: 0 var(--pad);
    }

    h1{ margin:0; font-size:20px; letter-spacing:.4px; font-family: "Fraunces", "Iowan Old Style", serif; }
    h2{ margin:0; font-size:16px; letter-spacing:.4px; font-family: "Fraunces", "Iowan Old Style", serif; text-transform: uppercase; }
    h3{ margin:0; font-size:13px; color: var(--muted); font-weight:700; letter-spacing:.6px; text-transform: uppercase; }

    .muted{ color: var(--muted); margin: 6px 0 0; }
    .small{ font-size:12px; color: var(--muted2); }
    .mono{ font-family: "Space Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .hidden{ display:none !important; }

    a{ color: inherit; text-decoration: none; }

    /* Topbar */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding: 14px 14px;
      border: 2px solid var(--line);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      z-index: 5;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 0;
    }

    .logo{
      width: 74px;
      height: 38px;
      border-radius: 4px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: #fff;
      border: 2px solid var(--line);
      font-weight:900;
      letter-spacing:.6px;
      user-select:none;
    }
    .logo span:first-child{ color: var(--accent); }
    .logo span:last-child{ color: #2a2a2a; }

    .brandtext{ min-width:0; }
    .brandtext .sub{ font-size:12px; color: var(--muted); margin-top:2px; }

    .topactions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    .tab-btn{
      padding: 8px 12px;
      border-radius: 999px;
      border: 2px solid var(--line);
      background: var(--card);
      font-weight: 800;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: .6px;
      color: var(--text);
    }

    .tab-btn.active{
      background: var(--accent);
      border-color: var(--line);
      color: #fff;
      box-shadow: var(--shadow);
    }

    /* Cards */
    .card{
      margin-top: 14px;
      border: 2px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      background: linear-gradient(180deg, var(--card), var(--card2));
      box-shadow: var(--shadow);
      animation: rise .5s ease both;
    }

    .tab-panel{ display:none; }
    .tab-panel.active{ display:block; }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }

    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight:700;
      letter-spacing:.8px;
      text-transform: uppercase;
      font-family: "Space Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    input,select,textarea{
      width:100%;
      padding: 10px 12px;
      border-radius: 4px;
      border: 2px solid var(--line);
      background: #fffdf6;
      color: var(--text);
      outline: none;
      font-family: "Space Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    textarea{ min-height: 84px; resize: vertical; }

    input::placeholder, textarea::placeholder { color: rgba(111,106,99,.65); }

    button{
      width:auto;
      padding: 10px 12px;
      border-radius: 4px;
      border: 2px solid var(--line);
      background: var(--accent);
      color: #fff;
      font-weight: 900;
      cursor: pointer;
      box-shadow: var(--shadow);
      text-transform: uppercase;
      letter-spacing: .6px;
    }

    button.secondary{
      background: var(--card);
      color: var(--text);
      border-color: var(--line);
      box-shadow: none;
    }

    button.danger{
      background: #fff1f1;
      border-color: var(--line);
      color: #7f1d1d;
      box-shadow: none;
    }

    button:disabled{
      opacity:.55;
      cursor: not-allowed;
    }

    /* Tables */
    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 12px;
      overflow:hidden;
      border-radius: 4px;
      border: 2px solid var(--line);
      background: #fffdf6;
    }
    th,td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      text-align:left;
      vertical-align: top;
      font-size: 13px;
    }
    th{
      background: #f1ebde;
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .8px;
    }
    tr:last-child td{ border-bottom:none; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 4px;
      border: 2px solid var(--line);
      background: #fffdf6;
      font-size: 12px;
      font-weight: 800;
      color: var(--text);
      white-space:nowrap;
      text-transform: uppercase;
      letter-spacing: .4px;
    }

    .pill.draft{ background: #f5f2ee; }
    .pill.plan{ background: rgba(14,165,163,.10); border-color: rgba(14,165,163,.35); }
    .pill.ready{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.35); }
    .pill.inv{ background: rgba(16,185,129,.12); border-color: rgba(16,185,129,.35); }
    .pill.paid{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.35); }
    .pill.confirmed{ background: rgba(14,165,163,.12); border-color: rgba(14,165,163,.35); }
    .pill.search{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.35); }

    .totals{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .stat{
      border: 2px solid var(--line);
      border-radius: 6px;
      background: #fffdf6;
      padding: 12px;
    }
    .stat .k{ color: var(--muted); font-size: 12px; font-weight: 800; letter-spacing:.3px; }
    .stat .v{ margin-top: 6px; font-size: 18px; font-weight: 950; }

    .hint{
      border: 2px dashed var(--line);
      background: #fffdf6;
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
      color: var(--muted);
      font-size: 13px;
    }

    /* NEW: categories admin toggle */
    .cardhead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
    }
    .cat-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    .cat-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      padding: 8px 10px;
      border: 2px solid var(--line);
      border-radius: 6px;
      background: #fffdf6;
    }
    .cat-name{ font-weight: 800; font-size: 13px; }
    .cat-actions{ display:none; }
    #categoriesCard.cat-admin .cat-actions{ display:inline-flex; }

    .iconbtn{
      padding: 8px 10px;
      border-radius: 4px;
      font-weight: 900;
      line-height: 1;
    }

    @keyframes rise{
      from{ opacity:0; transform: translateY(8px); }
      to{ opacity:1; transform: translateY(0); }
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .totals{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .topbar{ position: static; }
    }
</style>
</head>

<body>
  <div class="wrap">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand">
        <div class="logo"><span>RS</span><span>FOTO</span></div>
        <div class="brandtext">
          <h1>RSADM</h1>
          <div class="sub">Job & faktura overblik</div>
        </div>
      </div>

      <div class="topactions">
        <div class="small muted" id="whoami"></div>
        <button id="logoutBtn" type="button" class="secondary">Log ud</button>
      </div>
    </div>

    <div class="tabs hidden" id="tabs">
      <button class="tab-btn" data-tab="overblik" type="button">Overblik</button>
      <button class="tab-btn" data-tab="opret" type="button">Nyt job</button>
      <button class="tab-btn" data-tab="kunder" type="button">Kunder</button>
      <button class="tab-btn" data-tab="kategorier" type="button">Kategorier</button>
      <button class="tab-btn" data-tab="statistik" type="button">Statistik</button>
      <button class="tab-btn" data-tab="byline" type="button">Byline</button>
    </div>

    <!-- LOGIN -->
    <div class="card" id="loginCard">
      <h2>Login</h2>
      <p class="muted">Log ind med email + password (Supabase auth).</p>

      <div class="grid" style="margin-top:12px;">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="din@email.dk" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="loginBtn" type="button">Log ind</button>
        <button id="signupBtn" type="button" class="secondary">Opret bruger</button>
      </div>

      <p id="loginMsg" class="muted"></p>
      <p class="small muted" style="margin-top:0;">Tip: Hvis du f√•r ‚Äúpermission denied‚Äù, s√• tjek RLS policies.</p>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">

      <!-- Clients -->
      <div class="card tab-panel" data-panel="kunder">
        <h2>Kunder</h2>
        <p class="muted">Kunde-master (navn + timepris). Bruges til dropdown p√• jobs.</p>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label>Ny kunde (navn)</label>
            <input id="newClientName" placeholder="fx Seven Racing / AC Horsens" />
          </div>
          <div>
            <label>Timepris (kr. ex. moms)</label>
            <input id="newClientRate" type="number" min="0" step="0.01" placeholder="fx 850.00" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="addClientBtn" type="button">Tilf√∏j kunde</button>
          <button id="refreshClientsBtn" type="button" class="secondary">Opdater liste</button>
        </div>

        <table>
          <thead><tr><th>Kunde</th><th>Timepris</th><th>Handling</th></tr></thead>
          <tbody id="clientsTbody"></tbody>
        </table>

        <p class="muted" id="clientMsg"></p>
        <p class="small muted">Tip: Hvis sletning fejler, er kunden nok i brug af et job (FK). S√• lav i stedet ‚Äúarkiv√©r‚Äù senere.</p>
      </div>

      <!-- Categories -->
      <div class="card tab-panel" id="categoriesCard" data-panel="kategorier">
        <div class="cardhead">
          <h2>Kategorier</h2>
          <button id="toggleCatAdminBtn" type="button" class="secondary">Administrer</button>
        </div>

        <div class="row" style="margin-top:12px;">
          <div style="flex:1 1 300px;">
            <label>Ny kategori</label>
            <input id="newCategory" placeholder="fx Fodbold / H√•ndbold / Klub / Motorsport" />
          </div>
          <div style="display:flex; align-items:flex-end;">
            <button id="addCategoryBtn" type="button">Tilf√∏j kategori</button>
          </div>
        </div>

        <div class="cat-grid" id="categoriesGrid"></div>

        <p class="muted" id="catMsg"></p>
        <p class="small muted" style="margin-top:0;">Ved sletning: jobs der bruger kategorien s√¶ttes til <span class="mono">NULL</span>, og s√• slettes kategorien.</p>
      </div>

      <!-- New job -->
      <div class="card tab-panel" data-panel="opret">
        <h2>Nyt job</h2>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label>Faktura nummer (dit eget)</label>
            <input id="invoiceNo" placeholder="fx 2025-001 / e-conomic nr." />
          </div>

          <div>
            <label>Dato</label>
            <input id="jobDate" type="date" />
          </div>

          <!-- NEW: Job No -->
          <div>
            <label>Job nr (6 cifre)</label>
            <div class="row" style="gap:8px; flex-wrap:nowrap;">
              <input id="jobNo" class="mono" placeholder="Genererer‚Ä¶" readonly />
              <button id="copyJobNoBtn" type="button" class="secondary">Kopi√©r</button>
            </div>
            <div class="small muted" id="jobNoHint" style="margin-top:6px;"></div>
          </div>

          <div>
            <label>Overskrift</label>
            <input id="jobTitle" placeholder="fx Fodboldkamp i Horsens" />
          </div>

          <div>
            <label>Kategori</label>
            <select id="categorySelect"></select>
          </div>

          <div>
            <label>Status</label>
            <select id="statusSelect">
              <option value="planned">planlagt</option>
              <option value="ready">udf√∏rt</option>
              <option value="invoiced">faktureret</option>
            </select>
          </div>

          <div>
            <label>Kunde (v√¶lg fra liste)</label>
            <select id="clientSelect"></select>
            <div class="small muted" id="clientRateHint" style="margin-top:6px;"></div>
          </div>

          <div id="clientManualWrap" class="hidden">
            <label>Kunde (manuel)</label>
            <input id="clientManual" placeholder="fx Seven Racing / AC Horsens" />
          </div>

          <div>
            <label>Tid brugt (min / 1:30 / 2t 15m)</label>
            <input id="workText" placeholder="fx 2:15" />
          </div>

          <div>
            <label>Transport (min)</label>
            <input id="travelMinutes" type="number" min="0" step="1" placeholder="fx 45" />
          </div>

          <div>
            <label>Bel√∏b ex. moms</label>
            <input id="invoiceExVat" type="number" min="0" step="0.01" placeholder="fx 1250.00" />
            <div class="small muted" id="invoiceInclPreview" style="margin-top:6px;"></div>
          </div>

          <div>
            <label>Auto-beregn bel√∏b (ud fra timepris)</label>
            <div class="row" style="align-items:center; gap:8px; flex-wrap:nowrap;">
              <input id="autoCalcAmount" type="checkbox" checked style="width:auto;" />
              <div class="small muted" id="autoCalcHint"></div>
            </div>
          </div>

          <div style="grid-column: 1 / -1;">
            <label>Noter</label>
            <textarea id="notes" placeholder="fx sted, leverance, s√¶rlige ting..."></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="createJobBtn" type="button">Gem job</button>
          <button id="resetJobBtn" type="button" class="secondary">Nulstil</button>
        </div>

        <p class="muted" id="jobMsg"></p>
      </div>

      <!-- Jobs list -->
      <div class="card tab-panel" data-panel="overblik">
        <h2>Jobs</h2>

        <div class="row" style="margin-top:12px; align-items:flex-end; justify-content:space-between;">
          <div style="display:flex; gap:10px; flex-wrap:wrap; flex:1 1 auto;">
            <div style="min-width: 220px;">
              <label>S√∏g (jobnr/overskrift/kunde/faktura/noter)</label>
              <input id="search" placeholder="fx 123456 / bryllup / Horsens / 2025-" />
            </div>
            <div style="min-width: 160px;">
              <label>√Ör</label>
              <select id="yearFilter"></select>
            </div>
            <div style="min-width: 160px;">
              <label>Status</label>
              <select id="statusFilter">
                <option value="">Alle</option>
                <option value="planned">planlagt</option>
                <option value="ready">udf√∏rt</option>
                <option value="invoiced">faktureret</option>
              </select>
            </div>
          </div>

          <div style="display:flex; gap:10px; align-items:flex-end; flex:0 0 auto;">
            <button id="refreshBtn" type="button" class="secondary">Opdater</button>
            <button id="exportBtn" type="button">Eksport CSV</button>
          </div>
        </div>

        <div class="totals">
          <div class="stat"><div class="k">Jobs</div><div id="kpiJobs" class="v">0</div></div>
          <div class="stat"><div class="k">Arbejdstid</div><div id="kpiWork" class="v">0:00</div></div>
          <div class="stat"><div class="k">Transport</div><div id="kpiTravel" class="v">0:00</div></div>
          <div class="stat"><div class="k">Fakturering ex. moms</div><div id="kpiInv" class="v">0.00</div></div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Job nr</th>
              <th>Overskrift</th>
              <th>Dato</th>
              <th>Status</th>
              <th>Kunde</th>
              <th>Kategori</th>
              <th>Faktura nr</th>
              <th>Tid</th>
              <th>Transport</th>
              <th>Bel√∏b ex. moms</th>
              <th>Handling</th>
            </tr>
          </thead>
          <tbody id="jobsTbody"></tbody>
        </table>

        <p class="muted" id="tableMsg"></p>
      </div>

      <!-- Stats overview -->
      <div class="card tab-panel" data-panel="statistik">
        <h2>Statistik</h2>
        <p class="muted">Overblik over timer, transport og oms√¶tning.</p>

        <div class="row" style="margin-top:12px; align-items:flex-end; justify-content:space-between;">
          <div style="display:flex; gap:10px; flex-wrap:wrap; flex:1 1 auto;">
            <div style="min-width: 180px;">
              <label>M√•ned</label>
              <select id="statsMonth"></select>
            </div>
          </div>
        </div>

        <div class="totals">
          <div class="stat"><div class="k">Jobs</div><div id="statTotalJobs" class="v">0</div></div>
          <div class="stat"><div class="k">Arbejdstid</div><div id="statTotalWork" class="v">0:00</div></div>
          <div class="stat"><div class="k">Transport</div><div id="statTotalTravel" class="v">0:00</div></div>
          <div class="stat"><div class="k">Fakturering ex. moms</div><div id="statTotalInv" class="v">0.00</div></div>
        </div>

        <table>
          <thead>
            <tr>
              <th>M√•ned</th>
              <th>Jobs</th>
              <th>Arbejdstid</th>
              <th>Transport</th>
              <th>Fakturering ex. moms</th>
            </tr>
          </thead>
          <tbody id="statsMonthBody"></tbody>
        </table>
      </div>

      <!-- Report -->
      <div class="card tab-panel" data-panel="statistik">
        <h2>M√•nedsrapport pr. kunde</h2>
        <p class="muted">K√∏rer fra view <span class="mono">v_monthly_client_report</span>.</p>

        <div class="row" style="margin-top:12px; align-items:flex-end; justify-content:space-between;">
          <div style="display:flex; gap:10px; flex-wrap:wrap; flex:1 1 auto;">
            <div style="min-width: 180px;">
              <label>M√•ned</label>
              <select id="reportMonth"></select>
            </div>
            <div style="min-width: 240px;">
              <label>Kunde</label>
              <select id="reportClient"></select>
            </div>
          </div>

          <div style="display:flex; gap:10px; align-items:flex-end; flex:0 0 auto;">
            <button id="reportRefreshBtn" type="button" class="secondary">Opdater</button>
            <button id="reportExportBtn" type="button">Eksport CSV</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>M√•ned</th>
              <th>Kunde</th>
              <th>Jobs</th>
              <th>Arbejdstid</th>
              <th>Transport</th>
              <th>Fakturering ex. moms</th>
            </tr>
          </thead>
          <tbody id="reportTbody"></tbody>
        </table>

        <p class="muted" id="reportMsg"></p>
      </div>

      <!-- Byline -->
      <div class="card tab-panel" data-panel="byline">
        <div class="cardhead">
          <h2>Byline Tracker</h2>
          <button id="bylineRefreshBtn" type="button" class="secondary">Opdater</button>
        </div>
        <p class="muted">Henter data fra results.json (GitHub/Supabase).</p>

        <div class="row" style="margin-top:12px; align-items:flex-end;">
          <div style="min-width: 240px;">
            <label>Filter</label>
            <input id="bylineFilter" placeholder="dom√¶ne, titel, byline..." />
          </div>
        </div>

        <div class="totals">
          <div class="stat"><div class="k">Total</div><div id="bylineTotal" class="v">0</div></div>
          <div class="stat"><div class="k">Bekr√¶ftet</div><div id="bylineConfirmed" class="v">0</div></div>
          <div class="stat"><div class="k">Seneste 7 dage</div><div id="bylineLast7Count" class="v">0</div></div>
        </div>

        <h3>Seneste 7 dage</h3>
        <table>
          <thead>
            <tr>
              <th>Dato</th>
              <th>Status</th>
              <th>Dom√¶ne</th>
              <th>Titel</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody id="bylineLast7Tbody"></tbody>
        </table>

        <h3 style="margin-top:12px;">Alle</h3>
        <table>
          <thead>
            <tr>
              <th>Dato</th>
              <th>Status</th>
              <th>Dom√¶ne</th>
              <th>Titel</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody id="bylineTbody"></tbody>
        </table>

        <p class="muted" id="bylineMsg"></p>
      </div>

      <!-- EDIT CARD -->
      <div class="card hidden tab-panel" id="editCard" data-panel="overblik">
        <h2>Ret job <span class="mono" id="editId"></span></h2>
        <p class="small muted" id="editDbId"></p>

        <div class="grid" style="margin-top:12px;">
          <div>
            <label>Faktura nummer</label>
            <input id="editInvoiceNo" />
          </div>

          <div>
            <label>Dato</label>
            <input id="editJobDate" type="date" />
          </div>

          <div>
            <label>Overskrift</label>
            <input id="editJobTitle" />
          </div>

          <div>
            <label>Kategori</label>
            <select id="editCategorySelect"></select>
          </div>

          <div>
            <label>Status</label>
            <select id="editStatusSelect">
              <option value="planned">planlagt</option>
              <option value="ready">udf√∏rt</option>
              <option value="invoiced">faktureret</option>
            </select>
          </div>

          <div>
            <label>Kunde (v√¶lg fra liste)</label>
            <select id="editClientSelect"></select>
            <div class="small muted" id="editClientRateHint" style="margin-top:6px;"></div>
          </div>

          <div id="editClientManualWrap" class="hidden">
            <label>Kunde (manuel)</label>
            <input id="editClientManual" />
          </div>

          <div>
            <label>Tid brugt (min / 1:30 / 2t 15m)</label>
            <input id="editWorkText" />
          </div>

          <div>
            <label>Transport (min)</label>
            <input id="editTravelMinutes" type="number" min="0" step="1" />
          </div>

          <div>
            <label>Bel√∏b ex. moms</label>
            <input id="editInvoiceExVat" type="number" min="0" step="0.01" />
            <div class="small muted" id="editInvoiceInclPreview" style="margin-top:6px;"></div>
          </div>

          <div>
            <label>Auto-beregn bel√∏b (ud fra timepris)</label>
            <div class="row" style="align-items:center; gap:8px; flex-wrap:nowrap;">
              <input id="editAutoCalcAmount" type="checkbox" checked style="width:auto;" />
              <div class="small muted" id="editAutoCalcHint"></div>
            </div>
          </div>

          <div style="grid-column: 1 / -1;">
            <label>Noter</label>
            <textarea id="editNotes"></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="saveEditBtn" type="button">Gem rettelse</button>
          <button id="cancelEditBtn" type="button" class="secondary">Annuller</button>
          <button id="deleteJobBtn" type="button" class="danger">Slet job</button>
        </div>

        <p class="muted" id="editMsg"></p>
      </div>

    </div><!-- /#app -->

  </div><!-- /.wrap -->

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://epzbdezmbyyduqjthdzt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwemJkZXptYnl5ZHVxanRoZHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MDU3MzAsImV4cCI6MjA4MjA4MTczMH0.d_-8frGdHnvBO6smGThEUI81KUWI39rp5VX65O_HauU";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const BYLINE_JSON_URL = "./results.json";

    const $ = (id) => document.getElementById(id);

    const escapeHtml = (s) =>
      String(s ?? "").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    function inclVat(ex){ return Number(ex||0) * 1.25; }
    const round2 = (n) => Math.round((Number(n||0) + Number.EPSILON) * 100) / 100;

    const fmtH = (mins) => {
      const m = Math.max(0, Math.round(Number(mins)||0));
      const h = Math.floor(m/60);
      const r = m%60;
      return `${h}:${String(r).padStart(2,'0')}`;
    };

    function formatJobError(err){
      const msg = String(err?.message || "");
      if (msg.includes("job_no m√• ikke √¶ndres")) return "Jobnummer kan ikke √¶ndres efter oprettelse.";
      if (msg.includes("job_no skal v√¶re 6 cifre")) return "Jobnummer skal v√¶re 6 cifre.";
      if (msg.includes("job_no √•r-prefix")) return "Jobnummerets to f√∏rste cifre skal matche √•ret p√• datoen.";
      if (msg.includes("job_no er allerede brugt to gange")) return "Jobnummeret er allerede brugt to gange. Opret igen for nyt nummer.";
      return msg || "Der opstod en fejl. Pr√∏v igen.";
    }

    function statusBadge(st){
      const s = String(st||"planned");
      if (s === "planned") return `<span class="pill plan">Planlagt</span>`;
      if (s === "invoiced") return `<span class="pill inv">Faktureret</span>`;
      if (s === "ready") return `<span class="pill ready">Udf√∏rt</span>`;
      if (s === "paid") return `<span class="pill inv">Faktureret</span>`;
      return `<span class="pill draft">Planlagt</span>`;
    }

    function bylineStatusBadge(st){
      const s = String(st||"");
      if (s === "confirmed_on_page") return `<span class="pill confirmed">Bekr√¶ftet</span>`;
      return `<span class="pill search">S√∏gning</span>`;
    }

    function bylineDate(row){
      return row.published_at || row.search_date || (row.first_seen_utc ? row.first_seen_utc.slice(0,10) : "");
    }

    function dateToMs(iso){
      if (!iso) return 0;
      const d = new Date(`${iso}T00:00:00`);
      return Number.isNaN(d.getTime()) ? 0 : d.getTime();
    }

    function sortBylineNewest(rows){
      return [...rows].sort((a,b) => {
        const da = bylineDate(a);
        const db = bylineDate(b);
        if (da && db) return db.localeCompare(da);
        if (db) return 1;
        if (da) return -1;
        return 0;
      });
    }

    let bylineRows = [];
    let bylineLoaded = false;

    async function loadBylineData(force = false){
      if (bylineLoaded && !force) return;
      if (!BYLINE_JSON_URL || BYLINE_JSON_URL.includes("USERNAME/REPO")){
        $("bylineMsg").textContent = "S√¶t BYLINE_JSON_URL til din public results.json (GitHub eller Supabase).";
        return;
      }
      $("bylineMsg").textContent = "Henter byline-data‚Ä¶";
      try{
        const res = await fetch(BYLINE_JSON_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        bylineRows = Array.isArray(data) ? data : [];
        bylineLoaded = true;
        renderByline();
        $("bylineMsg").textContent = bylineRows.length ? "" : "Ingen data fundet i results.json.";
      }catch(e){
        $("bylineMsg").textContent = `Kunne ikke hente results.json: ${e.message}`;
      }
    }

    function renderByline(){
      const q = ($("bylineFilter")?.value || "").toLowerCase().trim();
      const filtered = bylineRows.filter(r => {
        if (!q) return true;
        return [r.domain, r.page_title, r.google_title, r.query_byline, r.confirmed_byline, r.url]
          .filter(Boolean)
          .some(v => String(v).toLowerCase().includes(q));
      });

      const confirmed = filtered.filter(r => r.status === "confirmed_on_page");
      const last7Cutoff = Date.now() - 7*24*60*60*1000;
      const last7 = filtered.filter(r => {
        const d = dateToMs(bylineDate(r));
        return d && d >= last7Cutoff;
      });

      $("bylineTotal").textContent = filtered.length;
      $("bylineConfirmed").textContent = confirmed.length;
      $("bylineLast7Count").textContent = last7.length;

      const renderRows = (rows, tbodyId) => {
        const tbody = $(tbodyId);
        tbody.innerHTML = "";
        sortBylineNewest(rows).forEach(r => {
          const tr = document.createElement("tr");
          const date = bylineDate(r) || "";
          const title = escapeHtml(r.page_title || r.google_title || "");
          const domain = escapeHtml(r.domain || "");
          const url = escapeHtml(r.url || "");
          tr.innerHTML = `
            <td class="mono">${date}</td>
            <td>${bylineStatusBadge(r.status)}</td>
            <td>${domain}</td>
            <td>${title}</td>
            <td><a href="${url}" target="_blank" rel="noopener">${url}</a></td>
          `;
          tbody.appendChild(tr);
        });
      };

      renderRows(last7, "bylineLast7Tbody");
      renderRows(filtered, "bylineTbody");
    }

    // Parse time input to minutes
    function parseWorkMinutes(input){
      const s = String(input||"").trim().toLowerCase();
      if (!s) return 0;

      // "1:30"
      if (/^\d+:\d{1,2}$/.test(s)) {
        const [h,m] = s.split(":").map(Number);
        return Math.max(0, (h*60) + (m||0));
      }

      // "90"
      if (/^\d+$/.test(s)) return Math.max(0, Number(s));

      // "2t 15m" / "2h 15m"
      const hm = s.match(/(\d+)\s*(t|h)\s*(\d+)?\s*m?/);
      if (hm) {
        const h = Number(hm[1]||0);
        const m = Number(hm[3]||0);
        return Math.max(0, (h*60)+m);
      }

      return 0;
    }

    // -------- STATE --------
    let user = null;
    let clients = [];
    let categories = [];
    let jobs = [];
    let reportRows = [];
    let editingId = null;

    // -------- UI --------
    function setLoggedInUI(isIn){
      $("loginCard").classList.toggle("hidden", isIn);
      $("app").classList.toggle("hidden", !isIn);

      $("logoutBtn").classList.toggle("hidden", !isIn);
      $("tabs").classList.toggle("hidden", !isIn);

      $("whoami").textContent = isIn && user?.email ? `Logget ind: ${user.email}` : "";
      if (isIn) setActiveTab(activeTab, false);
    }

    function initBylineUI(){
      $("bylineRefreshBtn").addEventListener("click", () => loadBylineData(true));
      $("bylineFilter").addEventListener("input", () => renderByline());
    }

    let activeTab = "overblik";
    function setActiveTab(name, updateHash = true){
      activeTab = name || "overblik";
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === activeTab);
      });
      document.querySelectorAll(".tab-panel").forEach(panel => {
        panel.classList.toggle("active", panel.dataset.panel === activeTab);
      });
      if (activeTab === "byline") loadBylineData();
      if (updateHash) history.replaceState(null, "", `#${activeTab}`);
    }

    function initTabs(){
      const initial = (location.hash || "").replace("#","") || "overblik";
      setActiveTab(initial, false);
      document.querySelectorAll("[data-tab]").forEach(btn => {
        btn.addEventListener("click", () => setActiveTab(btn.dataset.tab));
      });
    }

    // -------- JOB NO (6 digits) --------
    function getYearPrefix(dateStr){
      const y = (dateStr && String(dateStr).length >= 4)
        ? String(dateStr).slice(0,4)
        : String(new Date().getFullYear());
      return y.slice(2);
    }

    function formatJobNo(prefix, seq){
      return `${prefix}${String(seq).padStart(4,"0")}`;
    }

    async function countJobNoUses(jobNo){
      const { count, error } = await supabase
        .from("jobs")
        .select("id", { count: "exact", head: true })
        .eq("user_id", user.id)
        .eq("job_no", jobNo);
      if (error) throw error;
      return Number(count || 0);
    }

    async function allocateJobNoForPrefix(prefix){
      const { data, error } = await supabase
        .from("jobs")
        .select("job_no")
        .eq("user_id", user.id)
        .like("job_no", `${prefix}%`)
        .order("job_no", { ascending: false })
        .limit(1);

      if (error) throw error;

      let next = 1;
      if (data && data[0]?.job_no){
        const tail = Number(String(data[0].job_no).slice(-4));
        if (!Number.isNaN(tail)) next = tail + 1;
      }

      for (let i = 0; i < 20; i++){
        if (next > 9999) throw new Error("√Örets l√∏benummer er opbrugt.");
        const candidate = formatJobNo(prefix, next);
        const uses = await countJobNoUses(candidate);
        if (uses < 2) return candidate;
        next++;
      }
      throw new Error("Kunne ikke finde et unikt jobnummer. Pr√∏v igen.");
    }

    async function fillNewJobNo(){
      if (!user) return;
      const prefix = getYearPrefix($("jobDate").value);
      $("jobNo").value = "‚Ä¶‚Ä¶";
      $("jobNoHint").textContent = `Genererer ${prefix}XXXX‚Ä¶`;
      try{
        const n = await allocateJobNoForPrefix(prefix);
        $("jobNo").value = n;
        $("jobNoHint").textContent = `Jobnr for √•r ${prefix}: ${n}`;
      }catch(e){
        $("jobNo").value = "";
        $("jobNoHint").textContent = e?.message || "Kunne ikke generere jobnummer.";
      }
    }

    // -------- CLIENT HELPERS --------
    function getClientById(id){
      return clients.find(c => String(c.id) === String(id));
    }

    function updateClientManualVisibility(){
      const has = !!$("clientSelect").value;
      $("clientManualWrap").classList.toggle("hidden", has);
    }
    function updateEditClientManualVisibility(){
      const has = !!$("editClientSelect").value;
      $("editClientManualWrap").classList.toggle("hidden", has);
    }

    function updateClientRateHints(){
      const c = getClientById($("clientSelect").value);
      $("clientRateHint").textContent = c?.hourly_rate != null ? `Timepris: ${Number(c.hourly_rate).toFixed(2)} kr ex. moms` : "";
    }
    function updateEditClientRateHints(){
      const c = getClientById($("editClientSelect").value);
      $("editClientRateHint").textContent = c?.hourly_rate != null ? `Timepris: ${Number(c.hourly_rate).toFixed(2)} kr ex. moms` : "";
    }

    function updateNewInvoicePreview(){
      const ex = Number($("invoiceExVat").value || 0);
      $("invoiceInclPreview").textContent = ex ? `${inclVat(ex).toFixed(2)} kr inkl. moms` : "";
    }
    function updateEditInvoicePreview(){
      const ex = Number($("editInvoiceExVat").value || 0);
      $("editInvoiceInclPreview").textContent = ex ? `${inclVat(ex).toFixed(2)} kr inkl. moms` : "";
    }

    function maybeAutoCalcNewAmount(){
      const auto = $("autoCalcAmount").checked;
      const c = getClientById($("clientSelect").value);
      const mins = parseWorkMinutes($("workText").value);
      if (!auto) { $("autoCalcHint").textContent = "Auto-beregning er sl√•et fra."; return; }

      if (!c || c.hourly_rate == null || Number(c.hourly_rate) <= 0) {
        $("autoCalcHint").textContent = "V√¶lg en kunde med timepris for auto-beregning (eller indtast bel√∏b manuelt).";
        return;
      }
      const amount = round2((mins / 60) * Number(c.hourly_rate));
      $("invoiceExVat").value = amount ? amount.toFixed(2) : "";
      $("autoCalcHint").textContent = mins ? `Auto: ${fmtH(mins)} √ó ${Number(c.hourly_rate).toFixed(2)} = ${amount.toFixed(2)} kr ex. moms` : "Skriv tid for at beregne bel√∏b.";
      updateNewInvoicePreview();
    }

    function maybeAutoCalcEditAmount(){
      const auto = $("editAutoCalcAmount").checked;
      const c = getClientById($("editClientSelect").value);
      const mins = parseWorkMinutes($("editWorkText").value);
      if (!auto) { $("editAutoCalcHint").textContent = "Auto-beregning er sl√•et fra."; return; }

      if (!c || c.hourly_rate == null || Number(c.hourly_rate) <= 0) {
        $("editAutoCalcHint").textContent = "V√¶lg en kunde med timepris for auto-beregning (eller indtast bel√∏b manuelt).";
        return;
      }
      const amount = round2((mins / 60) * Number(c.hourly_rate));
      $("editInvoiceExVat").value = amount ? amount.toFixed(2) : "";
      $("editAutoCalcHint").textContent = mins ? `Auto: ${fmtH(mins)} √ó ${Number(c.hourly_rate).toFixed(2)} = ${amount.toFixed(2)} kr ex. moms` : "Skriv tid for at beregne bel√∏b.";
      updateEditInvoicePreview();
    }

    // -------- CLIENTS --------
    async function loadClients(){
      const { data, error } = await supabase
        .from("clients")
        .select("id,name,hourly_rate")
        .order("name", { ascending: true });

      if (error) {
        $("clientMsg").textContent = `Fejl ved hentning af kunder: ${error.message}`;
        clients = [];
        renderClientSelects();
        renderClientsTable();
        return;
      }

      clients = data ?? [];
      $("clientMsg").textContent = "";
      renderClientSelects();
      renderClientsTable();
    }

    function renderClientSelects(){
      const opts = clients.map(c => `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join("");
      $("clientSelect").innerHTML = `<option value="">(Manuel)</option>` + opts;
      $("editClientSelect").innerHTML = `<option value="">(Manuel)</option>` + opts;
    }

    function renderClientsTable(){
      $("clientsTbody").innerHTML = (clients || []).map(c => `
        <tr>
          <td>${escapeHtml(c.name)}</td>
          <td>${c.hourly_rate == null ? "" : Number(c.hourly_rate).toFixed(2)}</td>
          <td>
            <button type="button" class="secondary" data-del-client="${escapeHtml(c.id)}">Slet</button>
          </td>
        </tr>
      `).join("") || `<tr><td colspan="3" class="muted">Ingen kunder endnu</td></tr>`;

      document.querySelectorAll("button[data-del-client]").forEach(btn => {
        btn.addEventListener("click", () => deleteClient(btn.getAttribute("data-del-client")));
      });
    }

    async function deleteClient(id){
      if (!id) return;
      if (!confirm("Slet kunde? (kan fejle hvis kunden bruges af jobs)")) return;

      $("clientMsg").textContent = "";
      const { error } = await supabase.from("clients").delete().eq("id", id);
      if (error) { $("clientMsg").textContent = error.message; return; }

      $("clientMsg").textContent = "Kunde slettet ‚úÖ";
      await loadClients();
      await loadJobs();
      await loadReportRows();
    }

    // -------- CATEGORIES --------
    async function loadCategories(){
      const { data, error } = await supabase
        .from("categories")
        .select("id,name")
        .order("name", { ascending: true });

      if (error) {
        $("catMsg").textContent = `Fejl ved hentning af kategorier: ${error.message}`;
        categories = [];
        renderCategorySelects();
        renderCategoriesGrid();
        return;
      }

      categories = data ?? [];
      $("catMsg").textContent = "";
      renderCategorySelects();
      renderCategoriesGrid();
    }

    async function ensureDefaultCategories(){
      if (categories.length) return;
      const starter = ["Fodbold","H√•ndbold","Klub","Motorsport","Event","Bryllup","Studio"];
      const inserts = starter.map(name => ({ user_id: user.id, name }));
      const { error } = await supabase.from("categories").insert(inserts);
      if (error) console.warn(error);
      await loadCategories();
    }

    function renderCategorySelects(){
      const opts = categories.map(c => `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join("");
      $("categorySelect").innerHTML = `<option value="">(V√¶lg)</option>` + opts;
      $("editCategorySelect").innerHTML = `<option value="">(V√¶lg)</option>` + opts;
    }

    function renderCategoriesGrid(){
      const grid = $("categoriesGrid");
      if (!grid) return;

      grid.innerHTML = (categories || []).map(c => `
        <div class="cat-item">
          <div class="cat-name">${escapeHtml(c.name)}</div>
          <div class="cat-actions">
            <button type="button" class="secondary iconbtn" title="Slet" data-del-cat="${escapeHtml(c.id)}">üóë</button>
          </div>
        </div>
      `).join("") || `<div class="muted">Ingen kategorier endnu</div>`;

      document.querySelectorAll("button[data-del-cat]").forEach(btn => {
        btn.addEventListener("click", () => deleteCategory(btn.getAttribute("data-del-cat")));
      });
    }

    async function deleteCategory(id){
      if (!id) return;
      const cat = categories.find(c => c.id === id);
      const name = cat?.name || "kategorien";
      if (!confirm(`Slet "${name}"?\n\nOBS: Jobs der bruger kategorien f√•r sat kategori til (Ingen).`)) return;

      $("catMsg").textContent = "";

      // frig√∏r FK f√∏rst
      const { error: jobsErr } = await supabase
        .from("jobs")
        .update({ category_id: null })
        .eq("category_id", id);

      if (jobsErr) { $("catMsg").textContent = `Fejl (jobs update): ${jobsErr.message}`; return; }

      const { error: delErr } = await supabase
        .from("categories")
        .delete()
        .eq("id", id);

      if (delErr) { $("catMsg").textContent = `Fejl (slet kategori): ${delErr.message}`; return; }

      $("catMsg").textContent = "Kategori slettet ‚úÖ";
      await loadCategories();
      await loadJobs();
      await loadReportRows();
    }

    // -------- JOBS --------
    async function loadJobs(){
      const { data, error } = await supabase
        .from("jobs")
        .select(`
          id, job_no, title, job_date, status,
          client, client_id,
          invoice_no, work_minutes, work_text, travel_minutes, invoice_amount_ex_vat, notes,
          category_id,
          categories(name),
          clients(name,hourly_rate)
        `)
        .order("job_date", { ascending: false })
        .order("created_at", { ascending: false });

      if (error) {
        $("tableMsg").textContent = `Fejl ved hentning af jobs: ${error.message}`;
        jobs = [];
        renderAll();
        return;
      }

      jobs = (data ?? []).map(r => ({
        ...r,
        status: r.status || "draft",
        category_name: r.categories?.name ?? "",
        client_name: r.clients?.name ?? r.client ?? "",
        client_rate: r.clients?.hourly_rate ?? null
      }));

      $("tableMsg").textContent = "";
      renderAll();
    }

    // -------- REPORT --------
    async function loadReportRows(){
      $("reportMsg").textContent = "Henter rapport‚Ä¶";

      const { data, error } = await supabase
        .from("v_monthly_client_report")
        .select("user_id,ym,client,jobs,work_minutes,travel_minutes,invoice_ex_vat")
        .eq("user_id", user.id)
        .order("ym", { ascending: false })
        .order("client", { ascending: true });

      if (error) {
        $("reportMsg").textContent = error.message;
        reportRows = [];
        renderReport();
        return;
      }

      reportRows = data ?? [];
      $("reportMsg").textContent = "";
      renderReportDropdowns();
      renderReport();
    }

    function setSelectOptions(selectEl, values, placeholder = "(Alle)"){
      const opts = values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      selectEl.innerHTML = `<option value="">${placeholder}</option>` + opts;
    }

    function renderReportDropdowns(){
      const months = Array.from(new Set(reportRows.map(r => r.ym))).sort((a,b)=>b.localeCompare(a));
      const clientsUniq = Array.from(new Set(reportRows.map(r => r.client))).sort((a,b)=>a.localeCompare(b));
      setSelectOptions($("reportMonth"), months, "(Alle)");
      setSelectOptions($("reportClient"), clientsUniq, "(Alle)");
    }

    function filterReport(){
      const m = $("reportMonth").value || "";
      const c = $("reportClient").value || "";
      return reportRows.filter(r => (!m || r.ym === m) && (!c || r.client === c));
    }

    function renderReport(){
      const rows = filterReport();
      $("reportTbody").innerHTML = rows.map(r => `
        <tr>
          <td class="mono">${escapeHtml(r.ym)}</td>
          <td>${escapeHtml(r.client)}</td>
          <td>${Number(r.jobs||0)}</td>
          <td>${fmtH(r.work_minutes||0)}</td>
          <td>${fmtH(r.travel_minutes||0)}</td>
          <td>${Number(r.invoice_ex_vat||0).toFixed(2)}</td>
        </tr>
      `).join("") || `<tr><td colspan="6" class="muted">Ingen data for filter</td></tr>`;
    }

    function exportReportCSV(){
      const rows = filterReport();
      const header = ["M√•ned","Kunde","Jobs","Arbejdstid","Transport","Fakturering ex moms"];
      const lines = [header.join(",")];

      const esc = (s) => {
        const str = String(s ?? "");
        return /[,"\n]/.test(str) ? `"${str.replace(/"/g,'""')}"` : str;
      };

      rows.forEach(r=>{
        lines.push([
          esc(r.ym),
          esc(r.client),
          esc(r.jobs),
          esc(fmtH(r.work_minutes||0)),
          esc(fmtH(r.travel_minutes||0)),
          esc(Number(r.invoice_ex_vat||0).toFixed(2)),
        ].join(","));
      });

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `rsadm_rapport_${todayISO()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // -------- FILTERS / RENDER --------
    function renderYearFilter(){
      const years = Array.from(new Set(jobs.map(j => String(j.job_date || "").slice(0,4)).filter(Boolean))).sort((a,b)=>b.localeCompare(a));
      const cur = $("yearFilter").value;
      $("yearFilter").innerHTML = `<option value="">Alle</option>` + years.map(y=>`<option value="${y}">${y}</option>`).join("");
      if (years.includes(cur)) $("yearFilter").value = cur;
    }

    function computeStats(filtered){
      const totalJobs = filtered.length;
      const totalWorkMin = filtered.reduce((a,j)=>a+(Number(j.work_minutes)||0),0);
      const totalTravelMin = filtered.reduce((a,j)=>a+(Number(j.travel_minutes)||0),0);
      const totalInvoiceEx = filtered.reduce((a,j)=>a+(Number(j.invoice_amount_ex_vat)||0),0);
      return { totalJobs, totalWorkMin, totalTravelMin, totalInvoiceEx };
    }

    function getMonthKey(dateStr){
      return dateStr ? String(dateStr).slice(0,7) : "";
    }

    function renderStatsPanel(){
      if (!$("statsMonth")) return;

      const months = Array.from(new Set(jobs.map(j => getMonthKey(j.job_date)).filter(Boolean)))
        .sort((a,b)=>b.localeCompare(a));
      const cur = $("statsMonth").value || "";
      $("statsMonth").innerHTML = `<option value="">Alle</option>` + months.map(m => `<option value="${m}">${m}</option>`).join("");
      if (months.includes(cur)) $("statsMonth").value = cur;

      const selected = $("statsMonth").value || "";
      const subset = selected ? jobs.filter(j => getMonthKey(j.job_date) === selected) : jobs;
      const s = computeStats(subset);
      $("statTotalJobs").textContent = String(s.totalJobs);
      $("statTotalWork").textContent = fmtH(s.totalWorkMin);
      $("statTotalTravel").textContent = fmtH(s.totalTravelMin);
      $("statTotalInv").textContent = Number(s.totalInvoiceEx).toFixed(2);

      const byMonth = {};
      jobs.forEach(j => {
        const key = getMonthKey(j.job_date);
        if (!key) return;
        byMonth[key] ||= { jobs: 0, work: 0, travel: 0, inv: 0 };
        byMonth[key].jobs += 1;
        byMonth[key].work += Number(j.work_minutes) || 0;
        byMonth[key].travel += Number(j.travel_minutes) || 0;
        byMonth[key].inv += Number(j.invoice_amount_ex_vat) || 0;
      });

      const rows = Object.entries(byMonth).sort((a,b)=>b[0].localeCompare(a[0]));
      $("statsMonthBody").innerHTML = rows.map(([m,v]) => `
        <tr>
          <td class="mono">${escapeHtml(m)}</td>
          <td>${v.jobs}</td>
          <td>${fmtH(v.work)}</td>
          <td>${fmtH(v.travel)}</td>
          <td>${Number(v.inv).toFixed(2)}</td>
        </tr>
      `).join("") || `<tr><td colspan="5" class="muted">Ingen data endnu</td></tr>`;
    }

    function renderStats(filtered){
      const s = computeStats(filtered);
      $("kpiJobs").textContent = String(s.totalJobs);
      $("kpiWork").textContent = fmtH(s.totalWorkMin);
      $("kpiTravel").textContent = fmtH(s.totalTravelMin);
      $("kpiInv").textContent = Number(s.totalInvoiceEx).toFixed(2);
    }

    function filterJobs(){
      const q = ($("search").value || "").trim().toLowerCase();
      const year = $("yearFilter").value || "";
      const st = $("statusFilter").value || "";

      return jobs.filter(j => {
        const hay = `${j.job_no||""} ${j.title||""} ${j.client_name||""} ${j.invoice_no||""} ${j.notes||""}`.toLowerCase();
        if (q && !hay.includes(q)) return false;
        if (year && String(j.job_date||"").slice(0,4) !== year) return false;
        if (st && String(j.status||"") !== st) return false;
        return true;
      });
    }

    function renderJobsTable(filtered){
      $("jobsTbody").innerHTML = filtered.map(j => {
        const ex = Number(j.invoice_amount_ex_vat || 0);
        const incl = inclVat(ex);
        const shownNo = j.job_no || ""; // √∏nsket ID i UI
        return `
          <tr>
            <td class="mono">${escapeHtml(shownNo || "")}</td>
            <td>${escapeHtml(j.title || "")}</td>
            <td>${escapeHtml(j.job_date || "")}</td>
            <td>${statusBadge(j.status)}</td>
            <td>${escapeHtml(j.client_name || "")}</td>
            <td>${escapeHtml(j.category_name || "(Ingen)")}</td>
            <td>${escapeHtml(j.invoice_no || "")}</td>
            <td>${fmtH(j.work_minutes || 0)}<br><span class="small muted">${escapeHtml(j.work_text || "")}</span></td>
            <td>${fmtH(j.travel_minutes || 0)}</td>
            <td>
              ${ex.toFixed(2)}<br>
              <span class="small muted">(${incl.toFixed(2)} inkl.)</span>
            </td>
            <td><button type="button" class="secondary" data-edit="${escapeHtml(j.id)}">Ret</button></td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="11" class="muted">Ingen jobs matcher filter</td></tr>`;

      document.querySelectorAll("button[data-edit]").forEach(btn => {
        btn.addEventListener("click", () => openEdit(btn.getAttribute("data-edit")));
      });
    }

    function renderAll(){
      renderYearFilter();
      const filtered = filterJobs();
      renderStats(filtered);
      renderJobsTable(filtered);
      renderStatsPanel();
    }

    function exportCSV(rows){
      const header = ["JobNr","Overskrift","DBID","Dato","Status","Kunde","Kategori","FakturaNr","WorkMin","WorkTimer","WorkText","TransportMin","TransportTimer","Bel√∏bExMoms","Bel√∏bInclMoms","Noter"];
      const lines = [header.join(",")];

      const esc = (s) => {
        const str = String(s ?? "");
        return /[,"\n]/.test(str) ? `"${str.replace(/"/g,'""')}"` : str;
      };

      rows.forEach(j=>{
        const ex = Number(j.invoice_amount_ex_vat || 0);
        const incl = inclVat(ex);
        lines.push([
          esc(j.job_no || ""),
          esc(j.title || ""),
          esc(j.id),
          esc(j.job_date),
          esc(j.status),
          esc(j.client_name || j.client || ""),
          esc(j.category_name || ""),
          esc(j.invoice_no || ""),
          esc(j.work_minutes || 0),
          esc(fmtH(j.work_minutes || 0)),
          esc(j.work_text || ""),
          esc(j.travel_minutes || 0),
          esc(fmtH(j.travel_minutes || 0)),
          esc(ex.toFixed(2)),
          esc(incl.toFixed(2)),
          esc(j.notes || ""),
        ].join(","));
      });

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `rsadm_jobs_${todayISO()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // -------- CREATE / EDIT --------
    function resetJobForm(){
      $("invoiceNo").value = "";
      $("jobDate").value = todayISO();
      $("jobTitle").value = "";
      $("categorySelect").value = "";
      $("statusSelect").value = "planned";

      $("clientSelect").value = "";
      $("clientManual").value = "";
      updateClientManualVisibility();
      updateClientRateHints();

      $("workText").value = "";
      $("travelMinutes").value = "";
      $("invoiceExVat").value = "";
      $("invoiceInclPreview").textContent = "";
      $("notes").value = "";

      $("autoCalcAmount").checked = true;
      $("autoCalcHint").textContent = "";
      $("jobMsg").textContent = "";

      // NEW: job number
      fillNewJobNo();
    }

    function openEdit(id){
      const j = jobs.find(x => String(x.id) === String(id));
      if (!j) return;

      editingId = j.id;
      $("editCard").classList.remove("hidden");

      // show job number as primary label, db id below
      $("editId").textContent = j.job_no || "(mangler)";
      $("editDbId").textContent = `DB id: ${j.id}`;

      $("editInvoiceNo").value = j.invoice_no ?? "";
      $("editJobDate").value = j.job_date ?? todayISO();
      $("editJobTitle").value = j.title ?? "";
      $("editCategorySelect").value = j.category_id ?? "";
      $("editStatusSelect").value = j.status ?? "planned";

      $("editClientSelect").value = j.client_id ?? "";
      $("editClientManual").value = (j.client_id ? "" : (j.client ?? j.client_name ?? ""));
      updateEditClientManualVisibility();
      updateEditClientRateHints();

      $("editWorkText").value = j.work_text ?? "";
      $("editTravelMinutes").value = j.travel_minutes ?? 0;
      $("editInvoiceExVat").value = j.invoice_amount_ex_vat ?? "";
      $("editNotes").value = j.notes ?? "";

      $("editAutoCalcAmount").checked = true;
      updateEditInvoicePreview();
      maybeAutoCalcEditAmount();

      $("editMsg").textContent = "";
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    }

    // -------- AUTH --------
    async function checkSession(){
      const { data } = await supabase.auth.getSession();
      user = data?.session?.user ?? null;
      setLoggedInUI(!!user);

      if (user) {
        $("jobDate").value = todayISO();
        $("statusSelect").value = "planned";
        await loadClients();
        await loadCategories();
        await ensureDefaultCategories();
        await loadJobs();
        await loadReportRows();
        await fillNewJobNo();
      }
    }

    // -------- EVENTS --------
    $("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      user = null;
      setLoggedInUI(false);
    });

    $("loginBtn").addEventListener("click", async () => {
      $("loginMsg").textContent = "";
      const email = $("email").value.trim();
      const password = $("password").value;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { $("loginMsg").textContent = error.message; return; }

      user = data.user;
      setLoggedInUI(true);

      $("jobDate").value = todayISO();
      $("statusSelect").value = "planned";
      await loadClients();
      await loadCategories();
      await ensureDefaultCategories();
      await loadJobs();
      await loadReportRows();
      await fillNewJobNo();
    });

    $("signupBtn").addEventListener("click", async () => {
      $("loginMsg").textContent = "";
      const email = $("email").value.trim();
      const password = $("password").value;

      const { error } = await supabase.auth.signUp({ email, password });
      if (error) { $("loginMsg").textContent = error.message; return; }

      $("loginMsg").textContent = "Bruger oprettet. Log ind med samme email/password.";
    });

    // NEW: categories admin toggle
    $("toggleCatAdminBtn").addEventListener("click", () => {
      const card = $("categoriesCard");
      card.classList.toggle("cat-admin");
      $("toggleCatAdminBtn").textContent = card.classList.contains("cat-admin") ? "F√¶rdig" : "Administrer";
    });

    // Copy job no
    $("copyJobNoBtn").addEventListener("click", async () => {
      const v = ($("jobNo").value || "").trim();
      if (!v) return;
      try{
        await navigator.clipboard.writeText(v);
        $("jobNoHint").textContent = "Kopieret ‚úÖ";
      }catch{
        $("jobNoHint").textContent = "Kunne ikke kopiere (browser).";
      }
    });

    // Clients actions
    $("addClientBtn").addEventListener("click", async () => {
      $("clientMsg").textContent = "";

      const name = $("newClientName").value.trim();
      const hourly_rate = $("newClientRate").value === "" ? null : Number($("newClientRate").value);
      if (!name) { $("clientMsg").textContent = "Skriv et kundenavn."; return; }

      const { error } = await supabase.from("clients").insert({ user_id: user.id, name, hourly_rate });
      if (error) { $("clientMsg").textContent = error.message; return; }

      $("newClientName").value = "";
      $("newClientRate").value = "";
      $("clientMsg").textContent = "Kunde tilf√∏jet ‚úÖ";
      await loadClients();
    });

    $("refreshClientsBtn").addEventListener("click", loadClients);

    // Category actions
    $("addCategoryBtn").addEventListener("click", async () => {
      $("catMsg").textContent = "";
      const name = $("newCategory").value.trim();
      if (!name) { $("catMsg").textContent = "Skriv et kategorinavn."; return; }

      const { error } = await supabase.from("categories").insert({ user_id: user.id, name });
      if (error) { $("catMsg").textContent = error.message; return; }

      $("newCategory").value = "";
      $("catMsg").textContent = "Kategori tilf√∏jet ‚úÖ";
      await loadCategories();
    });

    // Create job
    $("createJobBtn").addEventListener("click", async () => {
      $("jobMsg").textContent = "";

      const invoice_no = $("invoiceNo").value.trim();
      const job_date = $("jobDate").value || todayISO();
      const title = $("jobTitle").value.trim() || null;
      const category_id = $("categorySelect").value || null;

      const status = $("statusSelect").value || "draft";

      const client_id = $("clientSelect").value || null;
      const client = client_id ? (getClientById(client_id)?.name || null) : ($("clientManual").value.trim() || null);

      const work_text = $("workText").value.trim();
      const work_minutes = parseWorkMinutes(work_text);

      // auto-calc (if enabled and client has rate)
      if ($("autoCalcAmount").checked && client_id) {
        const c = getClientById(client_id);
        if (c?.hourly_rate != null && Number(c.hourly_rate) > 0) {
          const amount = round2((work_minutes / 60) * Number(c.hourly_rate));
          $("invoiceExVat").value = amount ? amount.toFixed(2) : "";
          updateNewInvoicePreview();
        }
      }

      const travel_minutes = Math.max(0, Number($("travelMinutes").value || 0));
      const invoice_amount_ex_vat = $("invoiceExVat").value === "" ? null : Number($("invoiceExVat").value);
      const notes = $("notes").value.trim() || null;

      // NEW: job_no
      let job_no = ($("jobNo").value || "").trim();
      if (!job_no) job_no = await allocateJobNoForPrefix(getYearPrefix(job_date));
      const uses = await countJobNoUses(job_no);
      if (uses >= 2) {
        $("jobMsg").textContent = `Jobnr ${job_no} er allerede brugt to gange. Opret igen for nyt nr.`;
        await fillNewJobNo();
        return;
      }

      const { error } = await supabase.from("jobs").insert({
        user_id: user.id,
        job_no,
        title,
        invoice_no,
        job_date,
        category_id,
        status,
        client_id,
        client,
        work_minutes,
        work_text,
        travel_minutes,
        invoice_amount_ex_vat,
        notes
      });

      if (error) { $("jobMsg").textContent = formatJobError(error); return; }

      $("jobMsg").textContent = `Job gemt ‚úÖ (Job nr: ${job_no})`;
      resetJobForm();
      await loadJobs();
      await loadReportRows();
    });

    $("resetJobBtn").addEventListener("click", resetJobForm);

    // Edit actions
    $("cancelEditBtn").addEventListener("click", () => {
      editingId = null;
      $("editCard").classList.add("hidden");
    });

    $("saveEditBtn").addEventListener("click", async () => {
      if (!editingId) return;
      $("editMsg").textContent = "";

      const work_text = $("editWorkText").value.trim();
      const work_minutes = parseWorkMinutes(work_text);

      const client_id = $("editClientSelect").value || null;
      const client = client_id ? (getClientById(client_id)?.name || null) : ($("editClientManual").value.trim() || null);

      // auto-calc in edit
      if ($("editAutoCalcAmount").checked && client_id) {
        const c = getClientById(client_id);
        if (c?.hourly_rate != null && Number(c.hourly_rate) > 0) {
          const amount = round2((work_minutes / 60) * Number(c.hourly_rate));
          $("editInvoiceExVat").value = amount ? amount.toFixed(2) : "";
          updateEditInvoicePreview();
        }
      }

      const patch = {
        invoice_no: $("editInvoiceNo").value.trim(),
        job_date: $("editJobDate").value || todayISO(),
        title: $("editJobTitle").value.trim() || null,
        category_id: $("editCategorySelect").value || null,
        status: $("editStatusSelect").value || "draft",
        client_id,
        client,
        work_text,
        work_minutes,
        travel_minutes: Math.max(0, Number($("editTravelMinutes").value || 0)),
        invoice_amount_ex_vat: $("editInvoiceExVat").value === "" ? null : Number($("editInvoiceExVat").value),
        notes: $("editNotes").value.trim() || null
      };

      const { error } = await supabase.from("jobs").update(patch).eq("id", editingId);
      if (error) { $("editMsg").textContent = formatJobError(error); return; }

      $("editMsg").textContent = "Rettet ‚úÖ";
      await loadJobs();
      await loadReportRows();
      $("editCard").classList.add("hidden");
      editingId = null;
    });

    $("deleteJobBtn").addEventListener("click", async () => {
      if (!editingId) return;
      const j = jobs.find(x => String(x.id) === String(editingId));
      const label = j?.job_no ? `job ${j.job_no}` : `job (DB id: ${editingId})`;
      if (!confirm(`Slet ${label}?`)) return;

      const { error } = await supabase.from("jobs").delete().eq("id", editingId);
      if (error) { $("editMsg").textContent = error.message; return; }

      await loadJobs();
      await loadReportRows();
      $("editCard").classList.add("hidden");
      editingId = null;
    });

    // Filters & actions
    $("refreshBtn").addEventListener("click", async () => { await loadClients(); await loadJobs(); await loadReportRows(); });
    $("search").addEventListener("input", renderAll);
    $("yearFilter").addEventListener("change", renderAll);
    $("statusFilter").addEventListener("change", renderAll);
    $("statsMonth").addEventListener("change", renderStatsPanel);

    $("exportBtn").addEventListener("click", () => {
      const filtered = filterJobs();
      exportCSV(filtered);
    });

    // Report actions
    $("reportRefreshBtn").addEventListener("click", loadReportRows);
    $("reportExportBtn").addEventListener("click", exportReportCSV);
    $("reportMonth").addEventListener("change", renderReport);
    $("reportClient").addEventListener("change", renderReport);

    // Invoice previews + auto calc (NEW JOB)
    $("invoiceExVat").addEventListener("input", updateNewInvoicePreview);
    $("workText").addEventListener("input", () => { maybeAutoCalcNewAmount(); });
    $("autoCalcAmount").addEventListener("change", () => { maybeAutoCalcNewAmount(); });
    $("clientSelect").addEventListener("change", () => { updateClientManualVisibility(); updateClientRateHints(); maybeAutoCalcNewAmount(); });
    $("jobDate").addEventListener("change", fillNewJobNo);

    // Invoice previews + auto calc (EDIT)
    $("editInvoiceExVat").addEventListener("input", updateEditInvoicePreview);
    $("editWorkText").addEventListener("input", () => { maybeAutoCalcEditAmount(); });
    $("editAutoCalcAmount").addEventListener("change", () => { maybeAutoCalcEditAmount(); });
    $("editClientSelect").addEventListener("change", () => { updateEditClientManualVisibility(); updateEditClientRateHints(); maybeAutoCalcEditAmount(); });

    // Initial
    initBylineUI();
    initTabs();
    await checkSession();

    supabase.auth.onAuthStateChange(async (_event, session) => {
      user = session?.user ?? null;
      setLoggedInUI(!!user);
      if (user) {
        $("jobDate").value = todayISO();
        $("statusSelect").value = "planned";
        await loadClients();
        await loadCategories();
        await ensureDefaultCategories();
        await loadJobs();
        await loadReportRows();
        await fillNewJobNo();
      }
    });
  </script>
</body>
</html>
