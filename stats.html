<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RSADM – Statistik</title>

<style>
:root{
  --bg:#0b0e12;
  --card:#121721;
  --card2:#0f1420;
  --border:#1e2636;
  --text:#e7eaf0;
  --muted:#9aa3b2;
  --accent:#ff7a1a;
  --accent2:#1f6feb;
  --danger:#ff5d5d;
  --radius:18px;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:
    radial-gradient(800px 400px at 10% 10%, rgba(255,122,26,.08), transparent 60%),
    radial-gradient(800px 400px at 90% 80%, rgba(31,111,235,.08), transparent 60%),
    var(--bg);
  color:var(--text);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.wrap{
  max-width:1200px;
  margin:0 auto;
  padding:20px;
}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding:14px 18px;
  border-radius:var(--radius);
  background:linear-gradient(180deg, #141a26, #0e131d);
  border:1px solid var(--border);
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}

.brand{
  display:flex;
  align-items:center;
  gap:12px;
}
.logo{
  font-weight:900;
  letter-spacing:.5px;
}
.logo span{ color:var(--accent); }

.actions{
  display:flex;
  gap:10px;
  align-items:center;
}

button{
  background:#1a2030;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 14px;
  cursor:pointer;
  font-weight:600;
}
button.secondary{ background:#141a26; }
button.accent{
  background:linear-gradient(180deg, #ff8a3a, #ff6a00);
  border:none;
}
button:hover{ filter:brightness(1.05); }

.grid{
  display:grid;
  gap:18px;
  margin-top:20px;
}
.grid-2{ grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
.grid-3{ grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }

.card{
  background:linear-gradient(180deg, var(--card), var(--card2));
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}

.card h2{
  margin:0 0 14px 0;
  font-size:1.1rem;
}

.stat{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.stat .label{
  color:var(--muted);
  font-size:.85rem;
}
.stat .value{
  font-size:1.6rem;
  font-weight:800;
}

table{
  width:100%;
  border-collapse:collapse;
}
th, td{
  padding:10px 8px;
  border-bottom:1px solid var(--border);
  text-align:left;
}
th{
  color:var(--muted);
  font-size:.8rem;
  text-transform:uppercase;
  letter-spacing:.06em;
}
tfoot td{
  font-weight:800;
}

.muted{ color:var(--muted); }

@media (max-width:700px){
  .topbar{ flex-direction:column; align-items:flex-start; }
}
</style>
</head>

<body>
<div class="wrap">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="brand">
      <div class="logo">RS<span>ADM</span></div>
      <div class="muted">Statistik & rapporter</div>
    </div>
    <div class="actions">
      <a href="index.html"><button class="secondary">← Tilbage</button></a>
      <button id="logoutBtn">Log ud</button>
    </div>
  </div>

  <!-- OVERBLIK -->
  <div class="grid grid-3">
    <div class="card stat">
      <div class="label">Jobs</div>
      <div class="value" id="statJobs">–</div>
    </div>
    <div class="card stat">
      <div class="label">Arbejdstimer</div>
      <div class="value" id="statWork">–</div>
    </div>
    <div class="card stat">
      <div class="label">Omsætning (ex. moms)</div>
      <div class="value" id="statRevenue">–</div>
    </div>
  </div>

  <!-- KATEGORIER + MÅNEDER -->
  <div class="grid grid-2">
    <div class="card">
      <h2>Jobs pr. kategori</h2>
      <table>
        <thead>
          <tr><th>Kategori</th><th>Jobs</th><th>Timer</th></tr>
        </thead>
        <tbody id="catBody"></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Timer pr. måned</h2>
      <table>
        <thead>
          <tr><th>Måned</th><th>Timer</th></tr>
        </thead>
        <tbody id="monthBody"></tbody>
      </table>
    </div>
  </div>

  <!-- MÅNEDSRAPPORT -->
  <div class="card">
    <h2>Månedsrapport pr. kunde</h2>
    <table>
      <thead>
        <tr>
          <th>Måned</th>
          <th>Kunde</th>
          <th>Jobs</th>
          <th>Timer</th>
          <th>Kørsel</th>
          <th>Beløb</th>
        </tr>
      </thead>
      <tbody id="reportBody"></tbody>
    </table>
    <div style="margin-top:12px;">
      <button id="exportCsvBtn" class="secondary">CSV eksport</button>
    </div>
  </div>

</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabaseUrl = "https://epzbdezmbyyduqjthdzt.supabase.co";
const supabaseAnonKey = "INDSÆT_DIN_ANON_KEY_HER";
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const $ = id => document.getElementById(id);
let user = null;

/* AUTH GUARD */
const { data: { session } } = await supabase.auth.getSession();
if(!session){
  location.href = "index.html";
}
user = session.user;

/* LOG OUT */
$("logoutBtn").onclick = async () => {
  await supabase.auth.signOut();
  location.href = "index.html";
};

/* LOAD DATA */
async function loadStats(){
  const { data: jobs } = await supabase
    .from("jobs")
    .select("job_date, work_minutes, travel_minutes, invoice_amount_ex_vat, categories(name)")
    .eq("user_id", user.id);

  const { data: report } = await supabase
    .from("v_monthly_client_report")
    .select("*")
    .eq("user_id", user.id)
    .order("ym", { ascending:false });

  // OVERBLIK
  $("statJobs").textContent = jobs.length;
  $("statWork").textContent =
    (jobs.reduce((a,j)=>a+(j.work_minutes||0),0)/60).toFixed(1) + " t";
  $("statRevenue").textContent =
    jobs.reduce((a,j)=>a+Number(j.invoice_amount_ex_vat||0),0).toLocaleString("da-DK");

  // KATEGORIER
  const byCat = {};
  jobs.forEach(j=>{
    const k = j.categories?.name || "Ukendt";
    byCat[k] ||= { jobs:0, min:0 };
    byCat[k].jobs++;
    byCat[k].min += j.work_minutes||0;
  });
  $("catBody").innerHTML = Object.entries(byCat).map(([k,v])=>`
    <tr>
      <td>${k}</td>
      <td>${v.jobs}</td>
      <td>${(v.min/60).toFixed(1)}</td>
    </tr>
  `).join("");

  // MÅNEDER
  const byMonth = {};
  jobs.forEach(j=>{
    const m = j.job_date?.slice(0,7);
    if(!m) return;
    byMonth[m] = (byMonth[m]||0) + (j.work_minutes||0);
  });
  $("monthBody").innerHTML = Object.entries(byMonth)
    .sort((a,b)=>b[0].localeCompare(a[0]))
    .map(([m,min])=>`
      <tr>
        <td>${m}</td>
        <td>${(min/60).toFixed(1)}</td>
      </tr>
    `).join("");

  // RAPPORT
  $("reportBody").innerHTML = report.map(r=>`
    <tr>
      <td>${r.ym}</td>
      <td>${r.client}</td>
      <td>${r.jobs}</td>
      <td>${(r.work_minutes/60).toFixed(1)}</td>
      <td>${(r.travel_minutes/60).toFixed(1)}</td>
      <td>${Number(r.invoice_ex_vat).toLocaleString("da-DK")}</td>
    </tr>
  `).join("");

  // CSV
  $("exportCsvBtn").onclick = ()=>{
    const rows = [
      ["Måned","Kunde","Jobs","Timer","Kørsel","Beløb"],
      ...report.map(r=>[
        r.ym, r.client, r.jobs,
        (r.work_minutes/60).toFixed(1),
        (r.travel_minutes/60).toFixed(1),
        r.invoice_ex_vat
      ])
    ];
    const csv = rows.map(r=>r.join(";")).join("\n");
    const blob = new Blob([csv],{type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "rsadm_statistik.csv";
    a.click();
  };
}

loadStats();
</script>
</body>
</html>
